---
title: MongoDBé«˜å¯ç”¨æ–¹æ¡ˆä¹‹å¤åˆ¶é›†
icon: pen-to-square
date: 2024-11-19
category:
  - MongoDB
tag:
  - NoSQL
  - Database
---

# MongoDB é«˜å¯ç”¨æ–¹æ¡ˆ

## ç›®å½•

- [å¤åˆ¶é›†](#å¤åˆ¶é›†)
  - [é«˜å¯ç”¨ç‰¹æ€§](#é«˜å¯ç”¨ç‰¹æ€§)
  - [å¤åˆ¶é›†ç»“æ„](#å¤åˆ¶é›†ç»“æ„)
    - [PSS æ¨¡å¼ï¼ˆå®˜æ–¹æ¨èï¼‰](#PSSæ¨¡å¼å®˜æ–¹æ¨è)
    - [PSA æ¨¡å¼](#PSAæ¨¡å¼)
  - [å¤åˆ¶é›†ä¸­çš„å„ä¸ªè§’è‰²](#å¤åˆ¶é›†ä¸­çš„å„ä¸ªè§’è‰²)
    - [Primary â†’ ä¸»èŠ‚ç‚¹](#Primary--ä¸»èŠ‚ç‚¹)
    - [Secondary â†’ å¤‡èŠ‚ç‚¹](#Secondary--å¤‡èŠ‚ç‚¹)
    - [Arbiter â†’ æ€»è£èŠ‚ç‚¹](#Arbiter--æ€»è£èŠ‚ç‚¹)
  - [æ•°æ®å¤åˆ¶](#æ•°æ®å¤åˆ¶)
    - [oplog](#oplog)
  - [é€‰ä¸¾](#é€‰ä¸¾)
    - [é€‰ä¸¾åŸç†](#é€‰ä¸¾åŸç†)
    - [å¸¸è§é€‰é¡¹](#å¸¸è§é€‰é¡¹)
  - [è‡ªåŠ¨æ•…éšœè½¬ç§»](#è‡ªåŠ¨æ•…éšœè½¬ç§»)
  - [æ­å»º MongoDB å¤åˆ¶é›†](#æ­å»ºMongoDBå¤åˆ¶é›†)
    - [åˆ›å»ºæ•°æ®ç›®å½•](#åˆ›å»ºæ•°æ®ç›®å½•)
    - [å‡†å¤‡é…ç½®æ–‡ä»¶](#å‡†å¤‡é…ç½®æ–‡ä»¶)
    - [å¼€å¯æœåŠ¡](#å¼€å¯æœåŠ¡)
    - [é…ç½®å¤åˆ¶é›†](#é…ç½®å¤åˆ¶é›†)
      - [æ–¹å¼ä¸€](#æ–¹å¼ä¸€)
      - [æ–¹å¼äºŒ](#æ–¹å¼äºŒ)
    - [æŸ¥çœ‹çŠ¶æ€](#æŸ¥çœ‹çŠ¶æ€)
    - [å…¶ä»–å¸¸ç”¨æŒ‡ä»¤](#å…¶ä»–å¸¸ç”¨æŒ‡ä»¤)
    - [å¤åˆ¶é›†çš„è¿æ¥æ–¹å¼](#å¤åˆ¶é›†çš„è¿æ¥æ–¹å¼)
  - [å®‰å…¨è®¤è¯](#å®‰å…¨è®¤è¯)
    - [è¿æ¥ä¸»æœåŠ¡å™¨](#è¿æ¥ä¸»æœåŠ¡å™¨)
    - [åˆ›å»ºç”¨æˆ·](#åˆ›å»ºç”¨æˆ·)
    - [åœæ­¢æœåŠ¡](#åœæ­¢æœåŠ¡)
    - [åˆ›å»º keyFile æ–‡ä»¶](#åˆ›å»ºkeyFileæ–‡ä»¶)
    - [å¯åŠ¨æœåŠ¡](#å¯åŠ¨æœåŠ¡)
    - [æµ‹è¯•è¿æ¥](#æµ‹è¯•è¿æ¥)

## å¤åˆ¶é›†

### é«˜å¯ç”¨ç‰¹æ€§

å¤åˆ¶é›†é«˜å¯ç”¨çš„æ–¹é¢ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢

1. æ•°æ®å†™å…¥æ—¶å°†æ•°æ®è¿…é€Ÿå¤åˆ¶åˆ°å¦ä¸€ä¸ªç‹¬ç«‹èŠ‚ç‚¹ä¸Š
2. åœ¨æ¥å—å†™å…¥çš„èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶è‡ªåŠ¨é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„æ›¿ä»£èŠ‚ç‚¹

### å¤åˆ¶é›†ç»“æ„

#### PSS æ¨¡å¼ï¼ˆå®˜æ–¹æ¨èï¼‰

å®˜æ–¹æ¨èä¹Ÿæ˜¯æœ€ä¸ºå…¸å‹çš„ä¸€ä¸ªæ¨¡å¼ PSS ç”± 3 ä¸ªä»¥ä¸Šå…·æœ‰æŠ•ç¥¨æƒçš„èŠ‚ç‚¹ç»„æˆï¼ŒåŒ…æ‹¬ï¼š

1. ä¸»èŠ‚ç‚¹ï¼ˆPRIMARYï¼‰ï¼šæ¥å—å†™å…¥æ“ä½œå’Œé€‰ä¸¾æ—¶æŠ•ç¥¨
2. ä¸¤ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ä»èŠ‚ç‚¹ï¼ˆSECONDARYï¼‰ï¼šå¤åˆ¶ä¸»èŠ‚ç‚¹ä¸Šçš„æ–°æ•°æ®å’Œé€‰ä¸¾æ—¶æŠ•ç¥¨
3. å¦‚æœä¸»èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œåˆ™å¤åˆ¶é›†é€‰æ‹©å¤‡èŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹å¹¶ç»§ç»­æ­£å¸¸æ“ä½œã€‚æ—§çš„ä¸»èŠ‚ç‚¹åœ¨å¯ç”¨æ—¶é‡æ–°åŠ å…¥å¤åˆ¶é›†

#### PSA æ¨¡å¼

PSA æ¨¡å¼ç”±ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€ä¸€ä¸ªå¤‡èŠ‚ç‚¹å’Œä¸€ä¸ªä»²è£è€…èŠ‚ç‚¹ç»„æˆï¼ŒArbiter èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®å‰¯æœ¬ï¼Œä¹Ÿä¸æä¾›ä¸šåŠ¡çš„è¯»å†™æ“ä½œã€‚Arbiter èŠ‚ç‚¹å‘ç”Ÿæ•…éšœä¸å½±å“ä¸šåŠ¡ï¼Œä»…å½±å“é€‰ä¸¾æŠ•ç¥¨

### å¤åˆ¶é›†ä¸­çš„å„ä¸ªè§’è‰²

#### Primary â†’ ä¸»èŠ‚ç‚¹

ä¸»èŠ‚ç‚¹ï¼Œå…¶æ¥æ”¶æ‰€æœ‰çš„å†™è¯·æ±‚ï¼Œç„¶åæŠŠä¿®æ”¹åŒæ­¥åˆ°æ‰€æœ‰å¤‡èŠ‚ç‚¹ã€‚ä¸€ä¸ªå¤åˆ¶é›†åªèƒ½æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œå½“ä¸»èŠ‚ç‚¹â€œæŒ‚æ‰â€åï¼Œå…¶ä»–èŠ‚ç‚¹ä¼šé‡æ–°é€‰ä¸¾å‡ºæ¥ä¸€ä¸ªä¸»èŠ‚ç‚¹

#### Secondary â†’ å¤‡èŠ‚ç‚¹

å¤‡èŠ‚ç‚¹ï¼Œä¸ä¸»èŠ‚ç‚¹ä¿æŒåŒæ ·çš„æ•°æ®é›†ã€‚å½“ä¸»èŠ‚ç‚¹â€œæŒ‚æ‰â€æ—¶ï¼Œå‚ä¸ç«é€‰ä¸»èŠ‚ç‚¹ã€‚

#### Arbiter â†’ æ€»è£èŠ‚ç‚¹

ä»²è£èŠ‚ç‚¹ï¼Œåªç”¨äºå‚ä¸é€‰ä¸¾æŠ•ç¥¨ï¼Œæœ¬èº«ä¸æ‰¿è½½ä»»ä½•æ•°æ®ï¼Œåªä½œä¸ºæŠ•ç¥¨è§’è‰²ã€‚

### æ•°æ®å¤åˆ¶

å½“ä¸€ä¸ªä¿®æ”¹æ“ä½œï¼ˆæ’å…¥ï¼Œæ›´æ–°æˆ–åˆ é™¤ï¼‰åˆ°è¾¾ä¸»èŠ‚ç‚¹æ—¶ï¼Œä»–å¯¹æ•°æ®çš„æ“ä½œå°†ä¼šè¢«è®°å½•ä¸‹æ¥ï¼Œè¿™éƒ¨åˆ†è®°å½•ä¸‹æ¥çš„æ•°æ®æˆä¸º oplogï¼Œä»èŠ‚ç‚¹é€šè¿‡åœ¨ä¸»èŠ‚ç‚¹ä¸Šæ‰“å¼€ä¸€ä¸ª tailable æ¸¸æ ‡ä¸æ–­è·å–æ–°è¿›å…¥ä¸»èŠ‚ç‚¹çš„ oplogï¼Œå¹¶åœ¨è‡ªå·±çš„æ•°æ®ä¸Šå›æ”¾ï¼Œä»¥æ­¤ä¿æŒè·Ÿä¸»èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´

#### oplog

MongoDB oplog æ˜¯ Local åº“ä¸‹çš„ä¸€ä¸ªé›†åˆï¼Œç”¨æ¥ä¿å­˜å†™æ“ä½œæ‰€äº§ç”Ÿçš„**å¢é‡æ—¥å¿—**ï¼Œä¸”æ˜¯ä¸€ä¸ª**å›ºå®šé›†åˆ**ï¼Œå›ºå®šé›†åˆæ„å‘³ç€ä»–çš„å¤§å°æ˜¯ä¸€å®šçš„ï¼Œå¦‚æœæ•°æ®é‡è¾¾åˆ°äº†è¿™ä¸ªå¤§å°ï¼Œå°±ä¼šåˆ æ‰æœ€è€çš„å†å²æ•°æ®ï¼Œä¸»èŠ‚ç‚¹äº§ç”Ÿæ–°çš„ oplog Entryï¼Œä»èŠ‚ç‚¹é€šè¿‡å¤åˆ¶ oplog å¹¶åº”ç”¨æ¥ä¿æŒå’Œä¸»èŠ‚ç‚¹çš„çŠ¶æ€ä¸€è‡´ï¼Œoplog å¯¹æ•°æ®çš„äº‹åŠ¡å›æ»šï¼Œæ•°æ®å¤åˆ¶èµ·ç€éå¸¸å…³é”®æ€§çš„ä½œç”¨ã€‚

å½“ç„¶æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤æ¥æŸ¥çœ‹ oplog

```mongodb
use local
db.oplog.rs.find().sort({$natural:-1}).pretty()
```

æ›´å¤šçš„ oplog æ“ä½œ

```mongodb
local.system.replsetï¼šç”¨æ¥è®°å½•å½“å‰å¤åˆ¶é›†çš„æˆå‘˜ã€‚
local.startup_logï¼šç”¨æ¥è®°å½•æœ¬åœ°æ•°æ®åº“çš„å¯åŠ¨æ—¥å¿—ä¿¡æ¯ã€‚
local.replset.minvalidï¼šç”¨æ¥è®°å½•å¤åˆ¶é›†çš„è·Ÿè¸ªä¿¡æ¯ï¼Œå¦‚åˆå§‹åŒ–åŒæ­¥éœ€è¦çš„å­—æ®µã€‚
tsï¼š æ“ä½œæ—¶é—´ï¼Œå½“å‰timestamp + è®¡æ•°å™¨ï¼Œè®¡æ•°å™¨æ¯ç§’éƒ½è¢«é‡ç½®
vï¼šoplogç‰ˆæœ¬ä¿¡æ¯
opï¼šæ“ä½œç±»å‹:
iï¼šæ’â¼Šæ“ä½œ
uï¼šæ›´æ–°æ“ä½œ
dï¼šåˆ é™¤æ“ä½œ
cï¼šæ‰§è¡Œå‘½ä»¤ï¼ˆå¦‚createDatabaseï¼ŒdropDatabaseï¼‰
nï¼šç©ºæ“ä½œï¼Œç‰¹æ®Šç”¨é€”
nsï¼šæ“ä½œé’ˆå¯¹çš„é›†åˆ
oï¼šæ“ä½œå†…å®¹
o2ï¼šæ“ä½œæŸ¥è¯¢æ¡ä»¶ï¼Œä»…updateæ“ä½œåŒ…å«è¯¥å­—æ®µ
```

### é€‰ä¸¾

#### é€‰ä¸¾åŸç†

MongoDB å‡ºç°ä¸»èŠ‚ç‚¹æ•…éšœï¼Œå†…éƒ¨ä¼šé€šè¿‡é€‰ä¸¾çš„æ–¹å¼å®Œæˆæ•…éšœæ¢å¤ï¼Œé€‰ä¸¾çš„æ–¹æ³•æ˜¯é€šè¿‡ Raft ç®—æ³•æ¥å®ç°çš„

Raft ç®—æ³•ï¼š[https://raft.github.io/](https://raft.github.io/ "https://raft.github.io/")

MongoDB åœ¨ Raft çš„æ ‡å‡†ç®—æ³•ä¸Šè¿˜åŠ äº†ä¸€äº›è‡ªå·±çš„æ‰©å±•ï¼š

- æ”¯æŒ chainingAllowed é“¾å¼å¤åˆ¶ï¼Œå³å¤‡èŠ‚ç‚¹ä¸åªæ˜¯ä»ä¸»èŠ‚ç‚¹ä¸ŠåŒæ­¥æ•°æ®ï¼Œè¿˜å¯ä»¥é€‰æ‹©ä¸€ä¸ªç¦»è‡ªå·±æœ€è¿‘ï¼ˆå¿ƒè·³å»¶æ—¶æœ€å°ï¼‰çš„èŠ‚ç‚¹æ¥å¤åˆ¶æ•°æ®ã€‚
- å¢åŠ äº†é¢„æŠ•ç¥¨é˜¶æ®µï¼Œå³ preVoteï¼Œè¿™ä¸»è¦æ˜¯ç”¨æ¥é¿å…ç½‘ç»œåˆ†åŒºæ—¶äº§ç”Ÿ Term(ä»»æœŸ)å€¼æ¿€å¢çš„é—®é¢˜
- æ”¯æŒæŠ•ç¥¨ä¼˜å…ˆçº§ï¼Œå¦‚æœå¤‡èŠ‚ç‚¹å‘ç°è‡ªå·±çš„ä¼˜å…ˆçº§æ¯”ä¸»èŠ‚ç‚¹é«˜ï¼Œåˆ™ä¼šä¸»åŠ¨å‘èµ·æŠ•ç¥¨å¹¶å°è¯•æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚

å…·ä½“æµç¨‹å¯åˆ†ä¸º

1. å…·æœ‰æŠ•ç¥¨æƒçš„èŠ‚ç‚¹ä¹‹é—´ä¸¤ä¸¤äº’ç›¸å‘é€å¿ƒè·³
2. å½“ 5 æ¬¡å¿ƒè·³æœªæ”¶åˆ°æ—¶åˆ¤æ–­èŠ‚ç‚¹å¤±è”
3. å¦‚æœä¸»èŠ‚ç‚¹å¤±è”ï¼Œä»èŠ‚ç‚¹ä¼šå‘èµ·é€‰ä¸¾ï¼Œé€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹

   è¢«é€‰ä¸¾ä¸ºä¸»èŠ‚ç‚¹çš„èŠ‚ç‚¹

   1. èƒ½å¤Ÿä¸å¤šæ•°èŠ‚ç‚¹å»ºç«‹è¿æ¥
   2. å…·æœ‰è¾ƒæ–°çš„ oplog
   3. å…·æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§

4. å¦‚æœå¤±è”çš„æ˜¯ä»èŠ‚ç‚¹åˆ™ä¸ä¼šäº§ç”Ÿæ–°çš„é€‰ä¸¾
5. é€‰ä¸¾åŸºäº RAFT ä¸€è‡´æ€§ç®—æ³•å®ç°ï¼Œé€‰ä¸¾æˆåŠŸçš„å¿…è¦æ¡ä»¶æ˜¯å¤§å¤šæ•°æŠ•ç¥¨èŠ‚ç‚¹å­˜æ´»
6. å¤åˆ¶é›†ä¸­æœ€å¤šå¯ä»¥æœ‰ 50 ä¸ªèŠ‚ç‚¹ï¼Œä½†å…·æœ‰æŠ•ç¥¨æƒçš„èŠ‚ç‚¹æœ€å¤š 7 ä¸ªï¼Œå› ä¸ºä¸€æ—¦è¿‡å¤šçš„æˆå‘˜å‚ä¸æ•°æ®å¤åˆ¶ã€æŠ•ç¥¨è¿‡ç¨‹ï¼Œå°†ä¼šå¸¦æ¥æ›´å¤šå¯é æ€§æ–¹é¢çš„é—®é¢˜
   | æŠ•ç¥¨æˆå‘˜æ•° | å¤§å¤šæ•° | å®¹å¿ |
   | ----- | --- | -- |
   | 1 | 1 | 0 |
   | 2 | 2 | 0 |
   | 3 | 2 | 1 |
   | 4 | 3 | 1 |
   | 5 | 3 | 2 |
   | 6 | 4 | 2 |
   | 7 | 4 | 3 |

å½“å¤åˆ¶é›†å†…å­˜æ´»çš„æˆå‘˜æ•°é‡ä¸è¶³å¤§å¤šæ•°æ—¶ï¼Œæ•´ä¸ªå¤åˆ¶é›†å°†æ— æ³•é€‰ä¸¾å‡ºä¸»èŠ‚ç‚¹ï¼Œæ­¤æ—¶**æ— æ³•æä¾›å†™æœåŠ¡**ï¼Œè¿™äº›èŠ‚ç‚¹éƒ½å°†å¤„äº**åªè¯»çŠ¶æ€**ã€‚æ­¤å¤–ï¼Œå¦‚æœå¸Œæœ›é¿å…å¹³ç¥¨ç»“æœçš„äº§ç”Ÿï¼Œ**æœ€å¥½ä½¿ç”¨å¥‡æ•°ä¸ªèŠ‚ç‚¹æˆå‘˜**ï¼Œæ¯”å¦‚ 3 ä¸ªæˆ– 5 ä¸ªã€‚å½“ç„¶ï¼Œåœ¨ MongoDB å¤åˆ¶é›†çš„å®ç°ä¸­ï¼Œå¯¹äºå¹³ç¥¨é—®é¢˜å·²ç»æä¾›äº†è§£å†³æ–¹æ¡ˆï¼š

- ä¸ºé€‰ä¸¾å®šæ—¶å™¨å¢åŠ å°‘é‡çš„**éšæœºæ—¶é—´åå·®**ï¼Œè¿™æ ·é¿å…å„ä¸ªèŠ‚ç‚¹åœ¨åŒä¸€æ—¶åˆ»å‘èµ·é€‰ä¸¾ï¼Œæé«˜æˆåŠŸç‡
- ä½¿ç”¨**ä»²è£è€…è§’è‰²**ï¼Œè¯¥è§’è‰²ä¸åšæ•°æ®å¤åˆ¶ï¼Œä¹Ÿä¸æ‰¿æ‹…è¯»å†™ä¸šåŠ¡ï¼Œä»…ä»…ç”¨æ¥æŠ•ç¥¨

#### å¸¸è§é€‰é¡¹

å¤åˆ¶é›†èŠ‚ç‚¹æœ‰ä»¥ä¸‹å¸¸è§çš„é€‰é¡¹é…ç½®

- æ˜¯å¦å…·æœ‰æŠ•ç¥¨æƒï¼ˆv å‚æ•°ï¼‰ï¼šæœ‰åˆ™å‚ä¸æŠ•ç¥¨
- ä¼˜å…ˆçº§ï¼ˆpriorityï¼‰ï¼šä¼˜å…ˆçº§è¶Šé«˜çš„èŠ‚ç‚¹è¶Šä¼˜å…ˆæˆä¸ºä¸»èŠ‚ç‚¹ï¼Œä¼˜å…ˆçº§ä¸º 0 çš„èŠ‚ç‚¹æ— æ³•æˆä¸ºä¸»èŠ‚ç‚¹ï¼Œè¿™ä¸ªé€šå¸¸å¯ç”¨äºå°†æ€§èƒ½è¾ƒé«˜çš„æˆ–è€…è·ç¦»è¾ƒè¿‘çš„èŠ‚ç‚¹å°†å…¶ä¼˜å…ˆçº§è®¾é«˜ä¸€ç‚¹
- éšè—ï¼ˆhiddenï¼‰ï¼šå¤åˆ¶æ•°æ®ï¼Œä½†å¯¹åº”ç”¨ä¸å¯è§ï¼Œè€Œä¸”ä¼˜å…ˆçº§å¿…é¡»ä¸º 0ï¼Œä½†æ˜¯å…·å¤‡æŠ•ç¥¨æƒï¼Œè®¾ç½®äº† hidden çš„èŠ‚ç‚¹å¾€å¾€æ˜¯ç”¨äºæ•°æ®å¤‡ä»½ä¸­å¿ƒçš„
- å»¶è¿Ÿï¼ˆslaveDelayï¼‰ï¼šå¤åˆ¶ n ç§’ä¹‹å‰çš„æ•°æ®ï¼Œä¿æŒä¸ä¸»èŠ‚ç‚¹çš„æ—¶é—´å·®ï¼Œå› ä¸ºåˆ é™¤æ“ä½œä¹Ÿä¼šè¢«åŒæ­¥åˆ°å…¶ä»–å¤‡èŠ‚ç‚¹çš„ï¼Œæ‰€ä»¥å¦‚æœä¸å°å¿ƒè§¦å‘äº†åˆ é™¤æ“ä½œï¼Œé‚£å°†æ˜¯ä¸€ä¸ªéå¸¸å±é™©çš„æ“ä½œï¼Œè€Œè¿™ä¸ªé…ç½®å°±æ˜¯å°†æ•°æ®åŒæ­¥å»¶è¿Ÿ

### è‡ªåŠ¨æ•…éšœè½¬ç§»

ä¸¤ä¸ªå…³é”®æ€§é—®é¢˜ï¼š

1. å¤‡èŠ‚ç‚¹å¦‚ä½•æ„ŸçŸ¥åˆ°ä¸»èŠ‚ç‚¹å·²ç»å‘ç”Ÿæ•…éšœäº†ï¼Ÿ

   å¿ƒè·³æœºåˆ¶ï¼š

   ä¸€ä¸ªå½±å“æ£€æµ‹æœºåˆ¶çš„å› ç´ æ˜¯å¿ƒè·³ï¼Œåœ¨å¤åˆ¶é›†ç»„å»ºå®Œæˆä¹‹åï¼Œå„æˆå‘˜èŠ‚ç‚¹ä¼šå¼€å¯å®šæ—¶å™¨ï¼ŒæŒç»­å‘å…¶ä»–æˆå‘˜å‘èµ·å¿ƒè·³ï¼Œè¿™é‡Œæ¶‰åŠçš„å‚æ•°ä¸º**heartbeatIntervalMillis**ï¼Œå³å¿ƒè·³é—´éš”æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯**2s**ã€‚å¦‚æœå¿ƒè·³æˆåŠŸï¼Œåˆ™ä¼šæŒç»­ä»¥ 2s çš„é¢‘ç‡ç»§ç»­å‘é€å¿ƒè·³ï¼›å¦‚æœå¿ƒè·³å¤±è´¥ï¼Œåˆ™ä¼šç«‹å³é‡è¯•å¿ƒè·³ï¼Œä¸€ç›´åˆ°å¿ƒè·³æ¢å¤æˆåŠŸ

   é€‰ä¸¾è¶…æ—¶æ£€æµ‹ï¼š

   ä¸€æ¬¡å¿ƒè·³æ£€æµ‹å¤±è´¥å¹¶ä¸ä¼šç«‹å³è§¦å‘é‡æ–°é€‰ä¸¾ã€‚å®é™…ä¸Šé™¤äº†å¿ƒè·³ï¼Œæˆå‘˜èŠ‚ç‚¹è¿˜ä¼šå¯åŠ¨ä¸€ä¸ªé€‰ä¸¾è¶…æ—¶æ£€æµ‹å®šæ—¶å™¨ï¼Œè¯¥å®šæ—¶å™¨é»˜è®¤ä»¥**10s**çš„é—´éš”æ‰§è¡Œï¼Œå…·ä½“å¯ä»¥é€šè¿‡**electionTimeoutMillis**å‚æ•°æŒ‡å®šï¼š

   å¿ƒè·³å“åº”æˆåŠŸ â†’ åˆ™å–æ¶ˆä¸Šä¸€æ¬¡çš„ electionTimeout è°ƒåº¦ï¼Œå¹¶å‘èµ·æ–°ä¸€è½®çš„ electionTimeout å®šæ—¶æ£€æµ‹

   å¿ƒè·³å“åº”æ—¶é—´å†…ä¸èƒ½æˆåŠŸ â†’ è§¦å‘**electionTimeoutMillis**ä»»åŠ¡ï¼Œå¼€å¯é€‰ä¸¾

2. å¦‚ä½•é™ä½æ•…éšœè½¬ç§»å¯¹ä¸šåŠ¡äº§ç”Ÿçš„å½±å“ï¼Ÿ

   åœ¨å¤åˆ¶é›†å‘ç”Ÿä¸»å¤‡èŠ‚ç‚¹åˆ‡æ¢çš„æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°çŸ­æš‚çš„æ— ä¸»èŠ‚ç‚¹é˜¶æ®µï¼Œæ­¤æ—¶æ— æ³•æ¥å—ä¸šåŠ¡å†™æ“ä½œã€‚å¦‚æœå› ä¸ºä¸»èŠ‚ç‚¹æ•…éšœå¯¼è‡´çš„åˆ‡æ¢ï¼Œåˆ™å¯¹äºè¯¥èŠ‚ç‚¹çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½ä¼šäº§ç”Ÿè¶…æ—¶ã€‚å¦‚æœä½¿ç”¨ MongoDB 3.6 åŠä»¥ä¸Šç‰ˆæœ¬çš„é©±åŠ¨ï¼Œåˆ™å¯ä»¥é€šè¿‡å¼€å¯**retryWrite**æ¥é™ä½å½±å“ã€‚

   1. å¦‚æœæƒ³ä¸ä¸¢æ•°æ®é‡å¯å¤åˆ¶é›†ï¼Œæ›´ä¼˜é›…çš„æ‰“å¼€æ–¹å¼åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š
      1. é€ä¸ªé‡å¯å¤åˆ¶é›†é‡Œæ‰€æœ‰çš„ Secondary èŠ‚ç‚¹ï¼ˆä¸»ä»å¯æ¥å—æ•°æ®ï¼‰
      2. å¯¹ Primary å‘é€ rs.stepDown()å‘½ä»¤ï¼Œç­‰å¾… primary é™çº§ä¸º Secondary(ä»¤æ–°ä¸»æä¾›æœåŠ¡)
      3. é‡å¯é™çº§åçš„ Primary

### æ­å»º MongoDB å¤åˆ¶é›†

#### åˆ›å»ºæ•°æ®ç›®å½•

Linux/MacOS

```bash
mkdir -p /mongodb/db{1,2,3}
```

Windows ç³»ç»Ÿçš„è¯å°±åœ¨è‡ªå®šä¹‰ç›˜ä¸‹åˆ›å»º 3 ä¸ªå­˜å‚¨æ•°æ®åº“ä¿¡æ¯çš„ç›®å½•

#### å‡†å¤‡é…ç½®æ–‡ä»¶

å½“ç„¶å„ä¸ªå®ä¾‹åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ½æ˜¯åº”è¯¥è¦åœ¨ä¸åŒçš„æœºå™¨ä¸Šè¿›è¡Œéƒ¨ç½²çš„ï¼Œè€Œå•æœºå®éªŒçš„è¯å°±éœ€è¦æ³¨æ„å„ä¸ª mongodb å®ä¾‹çš„ port è¦ä¸ä¸€æ ·ï¼ŒsystemLog.path è¦ä¸ä¸€æ ·å’Œ storage.dbPath è¦ä¸ä¸€æ ·

```mongodb
 # /data/db1/mongod.conf
 systemLog:
   destination: file
   path: /mongodb/db1/mongod.log/ or /mongodb/db2/mongod.log or /mongodb/db3/mongod.log # log path
   logAppend: true
 storage:
   dbPath: /mongodb/db1 or /mongodb/db2  or /mongodb/db3 # data directory
 net:
   bindIp: 0.0.0.0
   port: 28017/28018/28019 # port
 replication:
   replSetName: rs0
 processManagement:
   fork: true mongodbé…ç½®æ–‡ä»¶
```

#### å¼€å¯æœåŠ¡

æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¼€å¯ MongoDB æœåŠ¡äº†

```bash
bin/mongod -f /mongodb/db1/mongodb.conf
bin/mongod -f /mongodb/db2/mongodb.conf
bin/mongod -f /mongodb/db3/mongodb.conf
```

#### é…ç½®å¤åˆ¶é›†

ä¸Šé¢ ğŸ‘† æˆ‘ä»¬çœ‹äº† 3 ä¸ªæœåŠ¡å®ä¾‹ï¼Œä½†æ˜¯ä»–ä»¬ä¹‹é—´æ˜¯äº’ä¸ç›¸å…³çš„ï¼Œä¹Ÿä¸çŸ¥é“å„è‡ªçš„å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä»–ä»¬å…³è”åˆ°ä¸€èµ·

æœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼Œé¦–å…ˆæˆ‘ä»¬å¾—å…ˆé€šè¿‡ mongosh è¿›å…¥ä¸»èŠ‚ç‚¹

```bash
mongosh --port 28017
```

##### æ–¹å¼ä¸€

```mongodb
rs.initate()

rs.add("HOSTNAME:28018")
rs.add("HOSTNAME:28019")

```

å¯ä»¥é€šè¿‡ hostname -f linux å‘½ä»¤æŸ¥çœ‹ hostname

##### æ–¹å¼äºŒ

```mongodb
rs.initiate({

  _id: "rs0",
  members:[
    {
      _id : 0,
      host: "localhost:28017"
    },
    {
       _id : 1,
      host: "localhost:28018"
    },
     _id : 2,
      host: "localhost:28019"
  ]

})
```

è¿™é‡Œçš„é…ç½®æ˜¯å°† id ä¸º 0 çš„å®ä¾‹é…ç½®ä¸ºä¸»æœºï¼Œå…¶ä»–çš„ä¸ºä»æœºï¼Œå®Œæˆäº†é…ç½®åï¼Œä¸»æœºå®ä¾‹çš„èº«ä»½ä¼šå‘ç”Ÿå˜åŒ–

```mongodb
rs0 [direct: other] test>
```

ä¸»ä»é…ç½®å®Œæˆåï¼Œä¸»æœºå…è®¸è¯»å†™ï¼Œä»æœºæ˜¯ä¸å…è®¸è¯»å†™çš„ï¼Œä»æœºæƒ³è¦è¿›è¡Œè¯»å–ï¼Œéœ€è¦è¿›è¡Œé…ç½®

```mongodb
rs0 [direct: primary] test> db.user.insertMany([{name:"test1"},{name:"test2"}])
{
  acknowledged: true,
  insertedIds: {
    '0': ObjectId('6723974161bdf98fff964033'),
    '1': ObjectId('6723974161bdf98fff964034')
  }
}
 ä¸»æœºå†™æ“ä½œ
```

```mongodb
rs0 [direct: primary] test> db.user.find()
[
  { _id: ObjectId('6723974161bdf98fff964033'), name: 'test1' },
  { _id: ObjectId('6723974161bdf98fff964034'), name: 'test2' }
] ä»æœºè¯»æ“ä½œ
```

å½“æˆ‘ä»¬ mongosh è¿æ¥ä»æœºæ—¶ï¼Œä¼šå‘ç°ä»æœºçš„èº«ä»½ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œå¹¶ä¸”å½“æˆ‘ä»¬å†™æ•°æ®çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šæç¤ºæˆ‘ä»¬ï¼šè¯´è¯¥èŠ‚ç‚¹ä¸æ˜¯ä¸»èŠ‚ç‚¹

```mongodb
rs0 [direct: secondary] test>

```

```mongodb
rs0 [direct: secondary] test> db.user.insert({name:"test3"})
DeprecationWarning: Collection.insert() is deprecated. Use insertOne, insertMany, or bulkWrite.
Uncaught:
MongoBulkWriteError[NotWritablePrimary]: not primary
 ä»èŠ‚ç‚¹å†™æ•°æ®
```

å½“ç„¶å¦‚æœæˆ‘ä»¬æƒ³è¦ä»èŠ‚ç‚¹è¿›è¡Œè¯»å–æ•°æ®çš„æ“ä½œï¼Œéœ€è¦æ‰§è¡ŒæŒ‡ä»¤

```mongodb
rs.secondaryOk()
```

#### æŸ¥çœ‹çŠ¶æ€

é€šè¿‡ rs.status()å¯ä»¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€

```mongodb
rs0 [direct: primary] test> rs.status()
{
  set: 'rs0',
  date: ISODate('2024-10-31T14:52:40.489Z'),
  myState: 1,
  term: Long('1'),
  syncSourceHost: '',
  syncSourceId: -1,
  heartbeatIntervalMillis: Long('2000'),
  majorityVoteCount: 2,
  writeMajorityCount: 2,
  votingMembersCount: 3,
  writableVotingMembersCount: 3,
  optimes: {
    lastCommittedOpTime: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
    lastCommittedWallTime: ISODate('2024-10-31T14:52:35.189Z'),
    readConcernMajorityOpTime: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
    appliedOpTime: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
    durableOpTime: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
    lastAppliedWallTime: ISODate('2024-10-31T14:52:35.189Z'),
    lastDurableWallTime: ISODate('2024-10-31T14:52:35.189Z')
  },
  lastStableRecoveryTimestamp: Timestamp({ t: 1730386345, i: 1 }),
  electionCandidateMetrics: {
    lastElectionReason: 'electionTimeout',
    lastElectionDate: ISODate('2024-10-31T14:34:44.934Z'),
    electionTerm: Long('1'),
    lastCommittedOpTimeAtElection: { ts: Timestamp({ t: 1730385274, i: 1 }), t: Long('-1') },
    lastSeenOpTimeAtElection: { ts: Timestamp({ t: 1730385274, i: 1 }), t: Long('-1') },
    numVotesNeeded: 2,
    priorityAtElection: 1,
    electionTimeoutMillis: Long('10000'),
    numCatchUpOps: Long('0'),
    newTermStartDate: ISODate('2024-10-31T14:34:45.067Z'),
    wMajorityWriteAvailabilityDate: ISODate('2024-10-31T14:34:45.169Z')
  },
  members: [
    {
      _id: 0,
      name: 'localhost:28017',
      health: 1,
      state: 1,
      stateStr: 'PRIMARY',
      uptime: 82606,
      optime: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
      optimeDate: ISODate('2024-10-31T14:52:35.000Z'),
      lastAppliedWallTime: ISODate('2024-10-31T14:52:35.189Z'),
      lastDurableWallTime: ISODate('2024-10-31T14:52:35.189Z'),
      syncSourceHost: '',
      syncSourceId: -1,
      infoMessage: '',
      electionTime: Timestamp({ t: 1730385284, i: 1 }),
      electionDate: ISODate('2024-10-31T14:34:44.000Z'),
      configVersion: 1,
      configTerm: 1,
      self: true,
      lastHeartbeatMessage: ''
    },
    {
      _id: 1,
      name: 'localhost:28018',
      health: 1,
      state: 2,
      stateStr: 'SECONDARY',
      uptime: 1086,
      optime: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
      optimeDurable: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
      optimeDate: ISODate('2024-10-31T14:52:35.000Z'),
      optimeDurableDate: ISODate('2024-10-31T14:52:35.000Z'),
      lastAppliedWallTime: ISODate('2024-10-31T14:52:35.189Z'),
      lastDurableWallTime: ISODate('2024-10-31T14:52:35.189Z'),
      lastHeartbeat: ISODate('2024-10-31T14:52:39.625Z'),
      lastHeartbeatRecv: ISODate('2024-10-31T14:52:40.295Z'),
      pingMs: Long('0'),
      lastHeartbeatMessage: '',
      syncSourceHost: 'localhost:28017',
      syncSourceId: 0,
      infoMessage: '',
      configVersion: 1,
      configTerm: 1
    },
    {
      _id: 2,
      name: 'localhost:28019',
      health: 1,
      state: 2,
      stateStr: 'SECONDARY',
      uptime: 1085,
      optime: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
      optimeDurable: { ts: Timestamp({ t: 1730386355, i: 1 }), t: Long('1') },
      optimeDate: ISODate('2024-10-31T14:52:35.000Z'),
      optimeDurableDate: ISODate('2024-10-31T14:52:35.000Z'),
      lastAppliedWallTime: ISODate('2024-10-31T14:52:35.189Z'),
      lastDurableWallTime: ISODate('2024-10-31T14:52:35.189Z'),
      lastHeartbeat: ISODate('2024-10-31T14:52:39.625Z'),
      lastHeartbeatRecv: ISODate('2024-10-31T14:52:39.160Z'),
      pingMs: Long('0'),
      lastHeartbeatMessage: '',
      syncSourceHost: 'localhost:28018',
      syncSourceId: 1,
      infoMessage: '',
      configVersion: 1,
      configTerm: 1
    }
  ],
  ok: 1,
  '$clusterTime': {
    clusterTime: Timestamp({ t: 1730386355, i: 1 }),
    signature: {
      hash: Binary.createFromBase64('AAAAAAAAAAAAAAAAAAAAAAAAAAA=', 0),
      keyId: Long('0')
    }
  },
  operationTime: Timestamp({ t: 1730386355, i: 1 })
}

```

æˆ‘ä»¬éœ€è¦å¸¸å…³æ³¨çš„æœ‰

- healthï¼šæˆå‘˜æ˜¯å¦å¥åº·ï¼Œé€šè¿‡å¿ƒè·³æ£€æµ‹
- state/stateStr:æˆå‘˜çš„çŠ¶æ€ï¼ŒPRIMARY è¡¨ç¤ºä¸»èŠ‚ç‚¹ï¼ŒSECONDARY è¡¨ç¤ºä»èŠ‚ç‚¹ï¼Œå¦‚æœèŠ‚ç‚¹å‡ºç°æ•…éšœçš„è¯ï¼Œä¼šå‡ºç°å…¶ä»–çŠ¶æ€ï¼Œæ¯”å¦‚ RECOVERY
- uptimeï¼šæˆå‘˜çš„å¯åŠ¨æ—¶é—´
- optimeã€optimeDateï¼šæˆå‘˜åŒæ­¥æœ€åä¸€æ¡ oplog çš„æ—¶é—´
- optimeDurableã€optimeDurableDateï¼šæˆå‘˜åŒæ­¥æœ€åä¸€æ¡ oplog æŒä¹…åŒ–çš„æ—¶é—´
- pingMsï¼šæˆå‘˜ä¸å½“å‰èŠ‚ç‚¹çš„ ping æ—¶å»¶
- syncingToï¼šæˆå‘˜çš„åŒæ­¥æ¥æº

å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ db.isMaster()æ¥æŸ¥çœ‹å½“å‰èŠ‚ç‚¹çš„è§’è‰²ï¼Œé…ç½®ä¿¡æ¯åŒ…å«äº†å¤åˆ¶é›†çš„æˆå‘˜åˆ—è¡¨ï¼ŒPrimaryï¼Œåè®®ç­‰ç›¸å…³é…ç½®ä¿¡æ¯

```mongodb
rs0 [direct: primary] test> db.isMaster()
{
  topologyVersion: {
    processId: ObjectId('6722570abb0dee2cb80de1ea'),
    counter: Long('6')
  },
  hosts: [ 'localhost:28017', 'localhost:28018', 'localhost:28019' ],
  setName: 'rs0',
  setVersion: 1,
  ismaster: true,
  secondary: false,
  primary: 'localhost:28017',
  me: 'localhost:28017',
  electionId: ObjectId('7fffffff0000000000000001'),
  lastWrite: {
    opTime: { ts: Timestamp({ t: 1730386645, i: 1 }), t: Long('1') },
    lastWriteDate: ISODate('2024-10-31T14:57:25.000Z'),
    majorityOpTime: { ts: Timestamp({ t: 1730386645, i: 1 }), t: Long('1') },
    majorityWriteDate: ISODate('2024-10-31T14:57:25.000Z')
  },
  maxBsonObjectSize: 16777216,
  maxMessageSizeBytes: 48000000,
  maxWriteBatchSize: 100000,
  localTime: ISODate('2024-10-31T14:57:33.568Z'),
  logicalSessionTimeoutMinutes: 30,
  connectionId: 35,
  minWireVersion: 0,
  maxWireVersion: 17,
  readOnly: false,
  ok: 1,
  '$clusterTime': {
    clusterTime: Timestamp({ t: 1730386645, i: 1 }),
    signature: {
      hash: Binary.createFromBase64('AAAAAAAAAAAAAAAAAAAAAAAAAAA=', 0),
      keyId: Long('0')
    }
  },
  operationTime: Timestamp({ t: 1730386645, i: 1 }),
  isWritablePrimary: true
}

```

#### å…¶ä»–å¸¸ç”¨æŒ‡ä»¤

| å‘½ä»¤                                   | åŠŸèƒ½æè¿°                                                       |
| -------------------------------------- | -------------------------------------------------------------- |
| \`rs.add()\`                           | å°†èŠ‚ç‚¹æ·»åŠ åˆ°å‰¯æœ¬é›†                                             |
| \`rs.addArb()\`                        | å°†ä»²è£èŠ‚ç‚¹æ·»åŠ åˆ°å‰¯æœ¬é›†                                         |
| \`rs.conf()\`                          | è¿”å›å‰¯æœ¬é›†é…ç½®æ–‡æ¡£                                             |
| \`rs.freeze()\`                        | é˜»æ­¢å½“å‰èŠ‚ç‚¹åœ¨ä¸€æ®µæ—¶é—´å†…å¯»æ±‚é€‰ä¸¾ä¸ºä¸»èŠ‚ç‚¹                       |
| \`rs.help()\`                          | è¿”å›å‰¯æœ¬é›†å‡½æ•°çš„åŸºæœ¬å¸®åŠ©æ–‡æœ¬                                   |
| \`rs.initiate()\`                      | åˆå§‹åŒ–æ–°çš„å‰¯æœ¬é›†                                               |
| \`rs.printReplicationInfo()\`          | ä»ä¸»èŠ‚ç‚¹çš„è§’åº¦æ‰“å°å‰¯æœ¬é›†çŠ¶æ€çš„æ ¼å¼åŒ–æŠ¥å‘Š                       |
| \`rs.printSecondaryReplicationInfo()\` | ä»ä»èŠ‚ç‚¹çš„è§’åº¦æ‰“å°å‰¯æœ¬é›†çŠ¶æ€çš„æ ¼å¼åŒ–æŠ¥å‘Š                       |
| \`rs.reconfig()\`                      | é€šè¿‡åº”ç”¨æ–°çš„å‰¯æœ¬é›†é…ç½®å¯¹è±¡æ¥é‡æ–°é…ç½®å‰¯æœ¬é›†                     |
| \`rs.remove()\`                        | ä»å‰¯æœ¬é›†ä¸­åˆ é™¤èŠ‚ç‚¹                                             |
| \`rs.status()\`                        | è¿”å›åŒ…å«å‰¯æœ¬é›†çŠ¶æ€ä¿¡æ¯çš„æ–‡æ¡£                                   |
| \`rs.stepDown()\`                      | å¯¼è‡´å½“å‰çš„ ä¸»èŠ‚ç‚¹å˜ä¸ºå¼ºåˆ¶é€‰ä¸¾çš„ä»èŠ‚ç‚¹                          |
| \`rs.syncFrom()\`                      | è®¾ç½®è¯¥å‰¯æœ¬é›†èŠ‚ç‚¹ä¸å“ªä¸ªèŠ‚ç‚¹è¿›è¡ŒåŒæ­¥ï¼Œå¤å†™é»˜è®¤çš„åŒæ­¥ç›®æ ‡é€‰æ‹©é€»è¾‘ |
| \`applyOps\`                           | å°† oplog æ¡ç›®åº”ç”¨äºå½“å‰æ•°æ®é›†çš„å†…éƒ¨å‘½ä»¤                        |
| \`hello\`                              | æ˜¾ç¤ºè¯¥èŠ‚ç‚¹åœ¨å‰¯æœ¬é›†ä¸­çš„è§’è‰²ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ˜¯å¦ä¸ºä¸»å‰¯æœ¬               |
| \`replSetAbortPrimaryCatchUp\`         | å¼ºåˆ¶å½“é€‰çš„ä¸»èŠ‚ç‚¹æ”¾å¼ƒåŒæ­¥ï¼ˆè¿½èµ¶ï¼‰è¿‡ç¨‹ï¼Œç„¶åå®Œæˆåˆ°ä¸»èŠ‚ç‚¹çš„è¿‡æ¸¡   |
| \`replSetFreeze\`                      | é˜»æ­¢å½“å‰èŠ‚ç‚¹åœ¨ä¸€æ®µæ—¶é—´å†…å¯»æ±‚é€‰ä¸¾ä¸ºä¸»èŠ‚ç‚¹                       |
| \`replSetGetConfig\`                   | è¿”å›å‰¯æœ¬é›†çš„é…ç½®å¯¹è±¡                                           |
| \`replSetGetStatus\`                   | è¿”å›æŠ¥å‘Šå‰¯æœ¬é›†çŠ¶æ€çš„æ–‡æ¡£                                       |
| \`replSetInitiate\`                    | åˆå§‹åŒ–æ–°çš„å‰¯æœ¬é›†                                               |
| \`replSetMaintenance\`                 | å¯ç”¨æˆ–ç¦ç”¨ç»´æŠ¤æ¨¡å¼ï¼Œè¯¥æ¨¡å¼ä½¿ä»èŠ‚ç‚¹å¤„äº RECOVERING çŠ¶æ€         |
| \`replSetReconfig\`                    | å°†æ–°é…ç½®åº”ç”¨äºç°æœ‰å‰¯æœ¬é›†                                       |
| \`replSetResizeOplog\`                 | åŠ¨æ€è°ƒæ•´ oplog å¤§å°                                            |

#### å¤åˆ¶é›†çš„è¿æ¥æ–¹å¼

å½“æˆ‘ä»¬æƒ³è¦è¿æ¥ Mongodb çš„å¤åˆ¶é›†æ—¶ï¼Œä¸€ç§æ–¹å¼æ˜¯å¦‚æœæˆ‘ä»¬çŸ¥é“ä¸»èŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿æ¥ä¸»èŠ‚ç‚¹æ¥å®Œæˆè¯»å†™æ“ä½œï¼Œä½†æ˜¯å¦‚æœä¸»èŠ‚ç‚¹å‘ç”Ÿäº†æ•…éšœï¼Œä¸»èŠ‚ç‚¹ä¾¿ä¼šåˆ‡æ¢ï¼Œè¿™ä¸ªæ—¶å€™å°±æ— æ³•é€šè¿‡è®¿é—®æ—§çš„ä¸»èŠ‚ç‚¹æ¥è®¿é—®å¤åˆ¶é›†äº†

```bash
mongosh --port 28017
```

æ‰€ä»¥å¼ºçƒˆæ¨èç¬¬äºŒç§ï¼Œé€šè¿‡é«˜å¯ç”¨ Uri çš„æ–¹å¼è¿æ¥ MongoDBï¼Œå½“ä¸»èŠ‚ç‚¹æ•…éšœåˆ‡æ¢åï¼ŒMongoDB å¼•æ“å¯è‡ªåŠ¨æ„ŸçŸ¥å¹¶å°†æµé‡è·¯ç”±åˆ°æ–°çš„ä¸»èŠ‚ç‚¹

```bash
mongosh mongodb://localhost:28017,localhost:28018,localhost:28019/admin?replicaSet=rs0
```

### å®‰å…¨è®¤è¯

ä½œä¸ºæ•°æ®åº“ï¼Œå®‰å…¨æ˜¯é¦–è¦é‡è¦çš„ï¼Œæ‰€ä»¥å¦‚ä½•ä¸ºå¤åˆ¶é›†é…å®‰å…¨è®¤è¯å‘¢ï¼Ÿ

#### è¿æ¥ä¸»æœåŠ¡å™¨

é¦–å…ˆè¿æ¥åˆ°ä¸»æœåŠ¡å™¨ mongodbï¼Œä½¿ç”¨ admin

```bash
bin/mongosh --port 28017
use admin
```

#### åˆ›å»ºç”¨æˆ·

```mongodb

 db.createUser( {
   user: "tang",
   pwd: "tang",
   roles: [
     { role: "clusterAdmin", db: "admin" } ,
     { role: "userAdminAnyDatabase", db: "admin"},
     { role: "userAdminAnyDatabase", db: "admin"},
     { role: "readWriteAnyDatabase", db: "admin"}]
    })

 åˆ›å»ºç”¨æˆ·
```

```mongodb
//å“åº”ç»“æœ
{
  ok: 1,
  '$clusterTime': {
    clusterTime: Timestamp({ t: 1730543556, i: 4 }),
    signature: {
      hash: Binary.createFromBase64('AAAAAAAAAAAAAAAAAAAAAAAAAAA=', 0),
      keyId: Long('0')
    }
  },
  operationTime: Timestamp({ t: 1730543556, i: 4 })
}

```

#### åœæ­¢æœåŠ¡

```bash
bin/mongod  -f /mongodb/db1/mongo.conf --shutdown
bin/mongod  -f /mongodb/db2/mongo.conf --shutdown
bin/mongod  -f /mongodb/db3/mongo.conf --shutdown

```

#### åˆ›å»º keyFile æ–‡ä»¶

keyFile æ˜¯é›†ç¾¤ä¹‹é—´çš„å®‰å…¨è®¤è¯ï¼Œå¢åŠ å®‰å…¨è®¤è¯æœºåˆ¶ KeyFileï¼Œå¼€å¯ keyFile è®¤è¯å°±é»˜è®¤å¼€å¯äº† auth è®¤è¯

åŸºäº openssl åˆ›å»ºä¸€ä¸ª 64 ä½å¯†é’¥å­˜å‚¨åˆ° mongo.key æ–‡ä»¶å†…

```bash
openssl rand -base64 756 > /mongodb/db1/mongo.key
```

è°ƒæ•´ key æ–‡ä»¶ä¸º 600 æƒé™ï¼Œå³åªæœ‰æ–‡ä»¶æ‰€æœ‰è€…å¯ä»¥è¯»å†™

```bash
openssl rand -base64 756 > /mongodb/db1/mongo.key
```

ç„¶åå°±å¯ä»¥é€šè¿‡ keyFile æ¥å¼€å¯ mongodb æœåŠ¡äº†

#### å¯åŠ¨æœåŠ¡

```bash
 bin/mongod  -f /mongodb/db1/mongo.conf --keyFile /mongodb/db1/mongo.key
 bin/mongod  -f /mongodb/db2/mongo.conf --keyFile /mongodb/db1/mongo.key
 bin/mongod  -f /mongodb/db3/mongo.conf --keyFile /mongodb/db1/mongo.key
```

#### æµ‹è¯•è¿æ¥

å¦‚æœç›´æ¥è¿æ¥æœåŠ¡å™¨çš„è¯ï¼Œè®¿é—®æ•°æ®ä¼šè¢«æ‹’ç»

```bash
rs0 [direct: primary] admin> db.user.find()
MongoServerError[Unauthorized]: command find requires authentication

```

åŸºäºç”¨æˆ·åå¯†ç ç™»å½•

```bash
mongosh --port 28017 -u tang -p tang --authenticationDatabase=admin
```
