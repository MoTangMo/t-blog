<template><div><h1 id="è¯¦è°ˆspring-security" tabindex="-1"><a class="header-anchor" href="#è¯¦è°ˆspring-security"><span>è¯¦è°ˆSpring Security</span></a></h1>
<h2 id="ç›®å½•" tabindex="-1"><a class="header-anchor" href="#ç›®å½•"><span>ç›®å½•</span></a></h2>
<ul>
<li><a href="#57%E7%89%88%E6%9C%AC%E5%89%8D%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE">5.7ç‰ˆæœ¬å‰åŸºæœ¬é…ç½®</a>
<ul>
<li><a href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96">å¯¼å…¥ä¾èµ–</a></li>
</ul>
</li>
<li><a href="#57%E7%89%88%E6%9C%AC%E5%90%8E%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE">5.7ç‰ˆæœ¬åçš„åŸºæœ¬é…ç½®</a>
<ul>
<li><a href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96">å¯¼å…¥ä¾èµ–</a></li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE">åŸºæœ¬é…ç½®</a></li>
</ul>
</li>
<li><a href="#Spring-Security%E7%9A%84%E8%AE%A4%E8%AF%81">Spring Securityçš„è®¤è¯</a>
<ul>
<li><a href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6">æ ¸å¿ƒç»„ä»¶</a></li>
<li><a href="#%E7%AE%80%E5%8D%95%E8%AE%A4%E8%AF%81">ç®€å•è®¤è¯</a>
<ul>
<li><a href="#%E8%A1%A8%E5%8D%95%E8%AE%A4%E8%AF%81">è¡¨å•è®¤è¯</a></li>
<li><a href="#%E5%AF%86%E7%A0%81%E5%AD%98%E5%82%A8">å¯†ç å­˜å‚¨</a>
<ul>
<li><a href="#%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8">å†…å­˜å­˜å‚¨</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%98%E5%82%A8">æ•°æ®åº“å­˜å‚¨</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90">è®¤è¯æµç¨‹åˆ†æ</a></li>
<li><a href="#%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE">è¿‡æ»¤å™¨é“¾</a></li>
<li><a href="#Remeber-me-">Remeber me </a>
<ul>
<li><a href="#%E5%BC%80%E5%90%AFRemeber-me">å¼€å¯Remeber me</a></li>
</ul>
</li>
<li><a href="#%E6%B3%A8%E9%94%80">æ³¨é”€</a></li>
<li><a href="#%E8%AE%A4%E8%AF%81%E4%BA%8B%E4%BB%B6">è®¤è¯äº‹ä»¶</a></li>
<li><a href="#%E6%8B%93%E5%B1%95%E5%B7%A9%E5%9B%BA">æ‹“å±•å·©å›º</a>
<ul>
<li><a href="#%E6%95%B4%E5%90%88JWT">æ•´åˆJWT</a></li>
<li><a href="#%E6%95%B4%E5%90%88SMS%E7%9F%AD%E4%BF%A1%E7%99%BB%E9%99%86%E8%AE%A4%E8%AF%81">æ•´åˆSMSçŸ­ä¿¡ç™»é™†è®¤è¯</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Spring Securityæ˜¯ä¸€ä¸ªJavaæ¡†æ¶ï¼Œç”¨äºä¿æŠ¤åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§ã€‚å®ƒæä¾›äº†ä¸€å¥—å…¨é¢çš„å®‰å…¨è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬èº«ä»½éªŒè¯ã€æˆæƒã€é˜²æ­¢æ”»å‡»ç­‰åŠŸèƒ½ã€‚Spring SecurityåŸºäº<strong>è¿‡æ»¤å™¨é“¾</strong>çš„æ¦‚å¿µï¼Œå¯ä»¥è½»æ¾åœ°é›†æˆåˆ°ä»»ä½•åŸºäºSpringçš„åº”ç”¨ç¨‹åºä¸­ã€‚å®ƒæ”¯æŒå¤šç§èº«ä»½éªŒè¯é€‰é¡¹å’Œæˆæƒç­–ç•¥ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©é€‚åˆçš„æ–¹å¼ã€‚æ­¤å¤–ï¼ŒSpring Securityè¿˜æä¾›äº†ä¸€äº›é™„åŠ åŠŸèƒ½ï¼Œå¦‚é›†æˆç¬¬ä¸‰æ–¹èº«ä»½éªŒè¯æä¾›å•†å’Œå•ç‚¹ç™»å½•ï¼Œä»¥åŠä¼šè¯ç®¡ç†å’Œå¯†ç ç¼–ç ç­‰ã€‚æ€»ä¹‹ï¼ŒSpring Securityæ˜¯ä¸€ä¸ªå¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„æ¡†æ¶ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜æé«˜åº”ç”¨ç¨‹åºçš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚</p>
<p>è™½è¯´Spring Securityå¾ˆå¼ºå¤§ï¼Œé›†æˆäº†éå¸¸å¤šçš„ä½¿ç”¨åœºæ™¯ï¼Œå‡ ä¹æ¶µç›–äº†æ‰€æœ‰çš„å®‰å…¨éœ€æ±‚ï¼Œä¸è¿‡è¿™ä¹Ÿä½¿å¾—ä»–å…·æœ‰ä¸€å®šçš„å¤æ‚æ€§ï¼Œä¸æƒ³èŠ±å¤ªå¤šæ—¶é—´æ¥ç ”ç©¶çš„è¯ï¼Œæˆ–è€…è¯´æ²¡æœ‰è¿™ä¹ˆå¤§çš„éœ€æ±‚çš„åœºæ™¯çš„è¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å­¦ä¹ æˆæœ¬è¾ƒä½çš„sa-tokenï¼Œshiroç­‰ã€‚</p>
<h3 id="_5-7ç‰ˆæœ¬å‰åŸºæœ¬é…ç½®" tabindex="-1"><a class="header-anchor" href="#_5-7ç‰ˆæœ¬å‰åŸºæœ¬é…ç½®"><span>5.7ç‰ˆæœ¬å‰åŸºæœ¬é…ç½®</span></a></h3>
<h4 id="å¯¼å…¥ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#å¯¼å…¥ä¾èµ–"><span>å¯¼å…¥ä¾èµ–</span></a></h4>
<div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre v-pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™æ ·æˆ‘ä»¬çš„SpringSecurityå°±ç®—æ˜¯æˆåŠŸå¼•å…¥äº†ï¼Œå½“æˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸å†™ çš„æ—¶å€™ï¼Œå…¶å®å°±æ˜¯å¯åŠ¨é»˜è®¤çš„è¿‡æ»¤é“¾é…ç½®</p>
<p>å¯¹äºé…ç½®ç±»ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ·»åŠ è¿™ä¹ˆä¸€ä¸ªæ³¨è§£æ¥å¼€å¯Spring Securityçš„é…ç½®ï¼ŒåŒæ—¶è¿˜éœ€è¦ç»§æ‰¿WebSecurityConfigurerAdapterç±»</p>
<blockquote>
<p>ğŸ“Œæ³¨æ„ï¼è¿™ä¸ªéœ€è¦æ³¨æ„ç‰ˆæœ¬ï¼š5.7ä»¥åçš„Spring Security ä¸å†éœ€è¦ç»§æ‰¿ WebSecurityConfigurerAdapter</p>
</blockquote>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomWebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å¯ä»¥è¯•ç€é‡å†™ä¸€äº›é…ç½®ç±»æ¥çœ‹ä¸€çœ‹ï¼Œå½“ç„¶å¦‚æœæˆ‘ä»¬ä¸é€‰æ‹©é‡å†™ï¼ŒSpring Securityä¼šæ‰§è¡Œä¸€äº›é»˜è®¤é…ç½®çš„</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>http<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å…¶å®æˆ‘ä»¬ç‚¹è¿›å»æŸ¥çœ‹ä¼šå‘ç°ï¼Œä»–å·²ç»æ˜¯å®ç°äº†ä¸€äº›é»˜è®¤é…ç½®äº†</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Using default configure(HttpSecurity). If subclassed this will potentially override subclass configure(HttpSecurity)."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExpressionUrlAuthorizationConfigurer<span class="token punctuation">.</span>AuthorizedUrl</span><span class="token punctuation">)</span>http<span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">httpBasic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™ configure(HttpSecurity http)æ¥è¿›è¡Œä¸€äº›è‡ªå®šä¹‰çš„å®‰å…¨é…ç½®ï¼Œè€ŒHttpSecurity ä¸»è¦å°±æ˜¯å¯¹Httpè®¿é—®è¿›è¡Œä¸€äº›é™åˆ¶é…ç½®ï¼Œæ¯”å¦‚è¯´å¯¹æŸäº›URLè¿›è¡Œè®¿é—®æ§åˆ¶ï¼Œé…ç½®ç™»å½•é¡µï¼Œæ³¨é”€é¡µéƒ½æ˜¯åœ¨è¿™é‡Œè¿›è¡Œé…ç½®</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http<span class="token punctuation">.</span>
            <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">"/home"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span> <span class="token comment">// é…ç½®è‡ªå®šä¹‰ç™»å½•é¡µ</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// é™¤äº† /ï¼Œ/homeï¼Œ/login å…¶ä»–éƒ½éœ€è¦è¿›è¡Œæ ¡éªŒ</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬è¿˜å¯ä»¥å®ç°configureGlobal(AuthenticationManagerBuilder) é…ç½®ä¸€äº›å†…å­˜ç”¨æˆ·ç”¨äºæµ‹è¯•</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configureGlobal</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        auth <span class="token generics"><span class="token punctuation">&lt;</span>3<span class="token punctuation">></span></span>
            <span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"admin"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_5-7ç‰ˆæœ¬åçš„åŸºæœ¬é…ç½®" tabindex="-1"><a class="header-anchor" href="#_5-7ç‰ˆæœ¬åçš„åŸºæœ¬é…ç½®"><span>5.7ç‰ˆæœ¬åçš„åŸºæœ¬é…ç½®</span></a></h2>
<h3 id="å¯¼å…¥ä¾èµ–-1" tabindex="-1"><a class="header-anchor" href="#å¯¼å…¥ä¾èµ–-1"><span>å¯¼å…¥ä¾èµ–</span></a></h3>
<div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre v-pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸºæœ¬é…ç½®" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬é…ç½®"><span>åŸºæœ¬é…ç½®</span></a></h3>
<p>åŸºæœ¬é…ç½®å·²ä¸å†éœ€è¦ç»§æ‰¿WebSecurityConfigurerAdapteräº†</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span><span class="token punctuation">{</span>
    

<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥å¾€æˆ‘ä»¬éœ€è¦é€šè¿‡ç»§æ‰¿é‡å†™configureè¿™ä¸ªæ–¹æ³•æ¥é…ç½®è¿‡æ»¤é“¾è§„åˆ™ï¼Œè€Œæ–°ç‰ˆæœ¬åˆ™æ˜¯éœ€è¦æ„å»ºäº†ä¸€ä¸ªè¿‡æ»¤é“¾å¯¹è±¡å¹¶é€šè¿‡@Beanæ³¨è§£æ³¨å…¥åˆ°IOCå®¹å™¨ä¸­ï¼Œç›¸å½“äºæˆ‘ä»¬é…ç½®äº†ä¸€ä¸ªæ–°çš„è¿‡æ»¤è§„åˆ™æ’å…¥åˆ°è¿‡æ»¤é“¾é‡Œäº†</p>
<p>ä¸ºä»€ä¹ˆè¿™ä¹ˆå¹²å‘¢ï¼Ÿæˆ‘çš„ç†è§£æ˜¯</p>
<ol>
<li>ä»¥Beançš„æ–¹å¼æ³¨å…¥åˆ°AuthenticationManagerä¸­ä¸€æ˜¯æ›´èƒ½è®©æˆ‘ä»¬ç†è§£Spring Securityçš„å·¥ä½œæ¨¡å¼ï¼Œå°±æ˜¯è®©æˆ‘ä»¬å¯ä»¥æ›´åŠ ç›´è§‚åœ°æ“ä½œè¿‡æ»¤é“¾ï¼ŒäºŒæ˜¯æé«˜é‡ç”¨æ€§ï¼Œæ¯•ç«Ÿä»¥Beançš„å½¢å¼å­˜åœ¨ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥éšæ—¶é‡ç”¨è¿™ä»½é…ç½®ã€‚</li>
<li>æ–°çš„é…ç½®æ–¹å¼æ›´å¥½åœ°æ”¯æŒå“åº”å¼ç¼–ç¨‹æ¨¡å‹ï¼Œå…è®¸åœ¨å“åº”å¼åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨Spring Security</li>
</ol>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
          http
                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                    auth
                            <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é™¤äº†è¿™éƒ¨åˆ†é…ç½®Spring Securityè¿˜æä¾›äº†è®¸å¤šå…¶ä»–çš„é…ç½®</p>
<div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre v-pre class="language-text"><code>ã€å¸¸ç”¨ã€‘#permitAll() æ–¹æ³•ï¼Œæ‰€æœ‰ç”¨æˆ·å¯è®¿é—®ã€‚
ã€å¸¸ç”¨ã€‘#denyAll() æ–¹æ³•ï¼Œæ‰€æœ‰ç”¨æˆ·ä¸å¯è®¿é—®ã€‚
ã€å¸¸ç”¨ã€‘#authenticated() æ–¹æ³•ï¼Œç™»å½•ç”¨æˆ·å¯è®¿é—®ã€‚
#anonymous() æ–¹æ³•ï¼Œæ— éœ€ç™»å½•ï¼Œå³åŒ¿åç”¨æˆ·å¯è®¿é—®ã€‚
#rememberMe() æ–¹æ³•ï¼Œé€šè¿‡ remember me ç™»å½•çš„ç”¨æˆ·å¯è®¿é—®ã€‚
#fullyAuthenticated() æ–¹æ³•ï¼Œé remember me ç™»å½•çš„ç”¨æˆ·å¯è®¿é—®ã€‚
#hasIpAddress(String ipaddressExpression) æ–¹æ³•ï¼Œæ¥è‡ªæŒ‡å®š IP è¡¨è¾¾å¼çš„ç”¨æˆ·å¯è®¿é—®ã€‚
ã€å¸¸ç”¨ã€‘#hasRole(String role) æ–¹æ³•ï¼Œ æ‹¥æœ‰æŒ‡å®šè§’è‰²çš„ç”¨æˆ·å¯è®¿é—®ã€‚
ã€å¸¸ç”¨ã€‘#hasAnyRole(String... roles) æ–¹æ³•ï¼Œæ‹¥æœ‰æŒ‡å®šä»»ä¸€è§’è‰²çš„ç”¨æˆ·å¯è®¿é—®ã€‚
ã€å¸¸ç”¨ã€‘#hasAuthority(String authority) æ–¹æ³•ï¼Œæ‹¥æœ‰æŒ‡å®šæƒé™(authority)çš„ç”¨æˆ·å¯è®¿é—®ã€‚
ã€å¸¸ç”¨ã€‘#hasAuthority(String... authorities) æ–¹æ³•ï¼Œæ‹¥æœ‰æŒ‡å®šä»»ä¸€æƒé™(authority)çš„ç”¨æˆ·å¯è®¿é—®ã€‚
ã€æœ€ç‰›ã€‘#access(String attribute) æ–¹æ³•ï¼Œå½“ Spring EL è¡¨è¾¾å¼çš„æ‰§è¡Œç»“æœä¸º true æ—¶ï¼Œå¯ä»¥è®¿é—®ã€‚
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="spring-securityçš„è®¤è¯" tabindex="-1"><a class="header-anchor" href="#spring-securityçš„è®¤è¯"><span>Spring Securityçš„è®¤è¯</span></a></h2>
<blockquote>
<p>ğŸ“Œè®¤è¯æ˜¯æŒ‡æˆ‘ä»¬å¦‚ä½•éªŒè¯è¯•å›¾è®¿é—®ç‰¹å®šèµ„æºçš„äººçš„èº«ä»½ã€‚ä¸€ä¸ªå¸¸è§çš„éªŒè¯ç”¨æˆ·çš„æ–¹æ³•æ˜¯è¦æ±‚ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚ä¸€æ—¦è¿›è¡Œäº†è®¤è¯ï¼Œæˆ‘ä»¬å°±çŸ¥é“äº†èº«ä»½å¹¶å¯ä»¥æ‰§è¡Œæˆæƒã€‚</p>
</blockquote>
<p>åœ¨æˆ‘ä»¬å¯¼å…¥SpringSecurityæ¡†æ¶æ—¶ï¼Œæ¡†æ¶ä¼šé»˜è®¤å¸®æˆ‘ä»¬æ·»åŠ ä¸€å±‚ä¿æŠ¤ç»™ç³»ç»Ÿçš„èµ„æºï¼Œæ¯æ¬¡è®¿é—®èµ„æºéƒ½ä¼šå…ˆç»è¿‡ä¸€å±‚èº«ä»½çš„æ ¡éªŒã€‚</p>
<p><strong>SpringSecurityåŠŸèƒ½çš„å®ç°ä¸»è¦ç”±ä¸€ç³»åˆ—çš„è¿‡æ»¤é“¾ç›¸äº’é…åˆå®Œæˆï¼Œä¹Ÿç§°ä¸ºè¿‡æ»¤å™¨é“¾æ¡ã€‚</strong></p>
<h3 id="æ ¸å¿ƒç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒç»„ä»¶"><span>æ ¸å¿ƒç»„ä»¶</span></a></h3>
<p>æ”¯æ’‘Spring Security çš„å¯¹Servlet åº”ç”¨çš„ä¸€å¥—è®¤è¯æµç¨‹éƒ½æ˜¯ä¾èµ–ç€ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p>
<figure><img src="@source/backend/image/image_HLmwMKcAy8.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<ul>
<li>
<p>SecurityContextHandler </p>
<ul>
<li>ç”¨äºç®¡ç†SpringContextçš„</li>
<li>ä¸€ä¸ªå·¥å…·ç±»ï¼Œå®ƒæä¾›äº†å¯¹å®‰å…¨ä¸Šä¸‹æ–‡çš„è®¿é—®ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨äº†ä¸€ä¸ªThreadLocalå¯¹è±¡æ¥å­˜å‚¨å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œè¿™æ„å‘³ç€å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
<li> ä½¿ç”¨ ThreadLocal æ¥å­˜å‚¨è¿™äº›ç»†èŠ‚ï¼Œè¿™å¾ˆé‡è¦ï¼Œæ„å‘³ç€SpringContext åœ¨åŒä¸€çº¿ç¨‹ä¸‹éƒ½æ˜¯å¯ä»¥å–æ¥ç”¨çš„</li>
</ul>
</li>
<li>
<p>SecurityContext </p>
<ul>
<li>ä»–å…¶å®å°±åŒ…å«äº†ä¸€ä¸ªAuthenticationå¯¹è±¡ï¼Œè€ŒAuthenticationé‡Œé¢å­˜çš„å°±æ˜¯ç”¨æˆ·çš„è¯¦ç»†è®¤è¯ä¿¡æ¯çš„ï¼Œä¸ºä»€ä¹ˆæ˜¯ä¸€ä¸ªå‘¢ï¼Ÿç»“åˆThreadLocalæ¥çœ‹ï¼Œè¿™ä¸ªAuthenticationå…¶å®å°±æ˜¯å½“å‰ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ã€‚å³æˆ‘ä»¬å¯ä»¥ä»SecurityContextä¸­è·å–å½“å‰ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯</li>
</ul>
</li>
<li>
<p>Authentication  </p>
<ul>
<li>å­˜å‚¨äº†å½“å‰ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯</li>
<li>Principal å¯ä»¥ç†è§£ä¸ºç”¨æˆ·çš„ä¿¡æ¯</li>
<li>Credentials å¯ä»¥ç†è§£ä¸ºå¯†ç ï¼ˆå‡­è¯ï¼‰</li>
<li>Authorities å¯ä»¥ç†è§£ä¸ºæƒé™</li>
</ul>
</li>
<li>
<p>GrantedAuthority</p>
<p>è¿™æ˜¯ç”¨äºç®¡ç†ç”¨æˆ·æƒé™çš„ï¼Œå¯ä»¥é€šè¿‡<code v-pre>Authentication.getAuthorities()</code>æ³•æ¥è·å–</p>
</li>
<li>
<p>UserDetails</p>
<ul>
<li>å…·å¤‡ä¸€ç³»åˆ—çš„å±æ€§çº¦æŸçš„</li>
</ul>
</li>
<li>
<p>UserDetailsService</p>
<ul>
<li>ä»æ•°æ®å­˜å‚¨ä¸­æ ¹æ®ç”¨æˆ·åæ‰¾åˆ°ç”¨æˆ·
UserDetailsServiceåªå®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ªæ¥å£æ–¹æ³•</li>
</ul>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>
    <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> var1<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
</ul>
<p>è¿™ä¸¤ä¸ªå¯¹è±¡ä¸è´Ÿè´£è®¤è¯å·¥ä½œï¼Œåªæ˜¯æä¾›æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½é€šè¿‡æ‹“å±•æ¥å®ç°è‡ªå®šä¹‰çš„æ•°æ®åº“ç»“æ„</p>
<ul>
<li>AuthenticationManager
<ul>
<li>è¿™æ˜¯å®šä¹‰äº†Spring Securiy çš„Filteræ˜¯å¦‚ä½•æ‰§è¡Œè®¤è¯çš„APIï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥ç®¡ç†Spring Securityçš„è®¤è¯è¿‡æ»¤é“¾çš„äº†</li>
<li>ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æƒ³è¦å®šä¹‰ä¸€ä¸ªè‡ªå·±çš„Filterï¼Œå¯ä»¥é€šè¿‡å®ç°AuthenticationManageræ¥å®Œæˆ</li>
</ul>
</li>
<li>ProviderManager
<ul>
<li>
<p>è¿™æ˜¯æœ€å¸¸ç”¨çš„AuthenticationManagerå®ç°ç±»ï¼Œå…¶å†…éƒ¨æ˜¯ç”±ä¸€è¿ä¸²çš„è¿‡æ»¤é“¾ç»„æˆï¼Œè¿™äº›è¿‡æ»¤é“¾ä¼šå±‚å±‚ä¼ é€’ï¼Œä¸€å±‚å‡ºé”™æˆ–è€…è¯´è®¤è¯é”™è¯¯å°±ä¸èƒ½å¤Ÿç»§ç»­å‘ä¸‹æ‰§è¡Œäº†ï¼Œä¼šæŠ›å‡ºAuthenticationException</p>
<figure><img src="@source/backend/image/image_BuD9G2nIWy.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
</li>
<li>
<p>å¦å¤–AuthenticationManageræ˜¯å¯ä»¥æœ‰å¤šä¸ªç»§æ‰¿ç±»çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„åº”ç”¨è®¾ç½®å¤šå¥—è¿‡æ»¤é“¾ï¼Œè¯´äººè¯å°±æ˜¯æˆ‘ä»¬å¯ä»¥æœ‰æ‰‹æœºå·è®¤è¯çš„åŒæ—¶ä¹Ÿå¯ä»¥æœ‰è´¦å·ã€å¯†ç è®¤è¯ç­‰å¤šç§è®¤è¯æ–¹å¼</p>
<figure><img src="@source/backend/image/image_qZuTrLGZ-n.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
</li>
</ul>
<blockquote>
<p>ä½ å¯ä»¥åœ¨ <a href="https://springdoc.cn/spring-security/servlet/authentication/architecture.html#servlet-authentication-providermanager" title="ProviderManager" target="_blank" rel="noopener noreferrer">ProviderManager<ExternalLinkIcon/></a> ä¸­æ³¨å…¥å¤šä¸ª <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/authentication/AuthenticationProvider.html" title="AuthenticationProvider" target="_blank" rel="noopener noreferrer">AuthenticationProvider<ExternalLinkIcon/></a> å®ä¾‹ã€‚æ¯ä¸ª <code v-pre>AuthenticationProvider</code> éƒ½æ‰§è¡Œä¸€ç§ç‰¹å®šç±»å‹çš„è®¤è¯ã€‚ä¾‹å¦‚ï¼Œ <a href="https://springdoc.cn/spring-security/servlet/authentication/passwords/dao-authentication-provider.html#servlet-authentication-daoauthenticationprovider" title="DaoAuthenticationProvider" target="_blank" rel="noopener noreferrer">DaoAuthenticationProvider<ExternalLinkIcon/></a> æ”¯æŒåŸºäºç”¨æˆ·å/å¯†ç çš„è®¤è¯ï¼Œè€Œ <code v-pre>JwtAuthenticationProvider</code> æ”¯æŒè®¤è¯JWTä»¤ç‰Œã€‚</p>
</blockquote>
</li>
<li>AbstractAuthenticationProcessingFilter
<ul>
<li>
<p>è¿™æ˜¯æ ¡éªŒç”¨æˆ·å‡­è¯å¾ˆé‡è¦çš„ä¸€ä¸ªFilterï¼Œä»–å…¶å®æ˜¯è¿‡æ»¤é“¾ï¼ˆSecurityFilterChainï¼‰ä¸­çš„ä¸€ç¯</p>
</li>
<li>
<p>ä»¥ä¸‹æ˜¯ä»–è®¤è¯çš„æµç¨‹ï¼Œè¿™æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œç†è§£ä¸‹æ¥ï¼Œå¯¹äºæˆ‘ä»¬åé¢å¯¹è®¤è¯æµç¨‹çš„ç†è§£åšæ‹“å±•æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼Œå…¶å®æ‰€æœ‰çš„è®¤è¯æµç¨‹éƒ½æ˜¯è¿™ä¹ˆè·‘çš„ï¼Œåªæ˜¯è¿™å›¾å¯¹å¯¹åº”çš„FIlterå’Œæ ¡éªŒä¿¡æ¯Authenticationåšäº†æŠ½è±¡è€Œå·²ï¼Œä¸å¦¨æˆ‘ä»¬å¯¹æ¯”ä¸€ä¸‹ä¸¤å¼ å›¾ï¼Œä¸Šå›¾å°±æ˜¯è®¤è¯æµç¨‹ï¼Œä¸‹å›¾æ˜¯ç”¨æˆ·è¡¨å•æäº¤çš„è®¤è¯æµç¨‹ã€‚</p>
<figure><img src="@source/backend/image/image_iF8AjzuH0o.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<figure><img src="@source/backend/image/image_XYuC61IfQF.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<ol>
<li>å½“ç”¨æˆ·æäº¤å‡­è¯çš„æ—¶å€™ï¼ŒAbstractAuthenticationProcessingFilterä¼šä»HttpServletRequestä¸­åˆ›å»ºä¸€ä¸ªä¼šæ ¹æ®æ ¡éªŒç±»å‹æ¥åˆ›å»ºè¦è¿›è¡Œè®¤è¯çš„Authentication</li>
<li>äº¤ç»™AuthenticationManagerè¿›è¡Œè®¤è¯</li>
<li>å¦‚æœè®¤è¯å¤±è´¥
<ol>
<li>SecurityContextHolderè¢«æ¸…ç©º</li>
<li>RememberMeServices.loginFailæ–¹æ³•ä¼šè¢«è°ƒç”¨</li>
<li>AuthenticationFailureHandler è¢«è°ƒç”¨</li>
</ol>
</li>
<li>è®¤è¯æˆåŠŸ
<ol>
<li>SessionAuthenticationStrategy è¢«é€šçŸ¥æœ‰æ–°ç™»é™†</li>
<li>Authentication æ˜¯åœ¨SecurityContextHolderä¸Šè®¾ç½®çš„ï¼Œå¦‚æœæƒ³è¦ä¿å­˜SecurityContextä»¥ä¾¿åœ¨åé¢çš„è¯·æ±‚ä¸­è‡ªåŠ¨è®¾ç½®ï¼Œéœ€è¦è°ƒç”¨SecurityContext Repository,saveContext</li>
<li>RemeberMeServices.loginSuccessè¢«è°ƒç”¨</li>
<li>ApplicationEventPublisher å‘å¸ƒä¸€ä¸ªInteractiveAuthenticationSuccessEventäº‹ä»¶</li>
<li>AuthenticationSuccessHandlerè¢«è°ƒç”¨</li>
</ol>
</li>
</ol>
</li>
</ul>
</li>
</ul>
<h3 id="ç®€å•è®¤è¯" tabindex="-1"><a class="header-anchor" href="#ç®€å•è®¤è¯"><span>ç®€å•è®¤è¯</span></a></h3>
<h4 id="è¡¨å•è®¤è¯" tabindex="-1"><a class="header-anchor" href="#è¡¨å•è®¤è¯"><span>è¡¨å•è®¤è¯</span></a></h4>
<p>è¡¨å•è®¤è¯å…¶å®é…ç½®èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä¹Ÿå°±æ˜¯ä¸€å¥é…ç½®çš„äº‹å„¿ï¼Œè€ŒSpring Security è¡¨å•ç™»å½•æ˜¯é»˜è®¤è¢«å¯ç”¨çš„ï¼Œæ‰€ä»¥å¦‚æœæ˜¯æƒ³è¦é»˜è®¤çš„è¡¨å•ç™»å½•æ–¹å¼çš„è¯ï¼Œå…¶å®æ˜¯ä¸éœ€è¦é…ç½®çš„ï¼Œå¦‚æœæƒ³è¦é…ç½®æˆ‘ä»¬éœ€è¦è¿™æ ·é…ç½®ï¼Œå…¶å®å°±æ˜¯å¯¹formLoginè¿›è¡Œé…ç½®</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">filterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  http
    <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token function">withDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬è¿˜å¯ä»¥é…ç½®å…·ä½“çš„ç™»é™†é¡µé¢ï¼Œæˆ–è€…è¯´ç™»é™†æ¥å£</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">filterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  http
    <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span>form <span class="token operator">-></span> form
      <span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸é…ç½®ï¼Œç›´æ¥å¯åŠ¨çš„è¯ï¼Œå°±ä¼šå¾—åˆ°ä¸€ä¸ªä¸´æ—¶çš„å¯†ç ï¼Œç»“åˆåˆå§‹åŒ–ç”¨æˆ·åuserå°±å¯ä»¥è·‘é€šé»˜è®¤çš„è®¤è¯é€»è¾‘äº†</p>
<figure><img src="@source/backend/image/image_fJtmOLTwA6.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<h4 id="å¯†ç å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#å¯†ç å­˜å‚¨"><span>å¯†ç å­˜å‚¨</span></a></h4>
<h5 id="å†…å­˜å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#å†…å­˜å­˜å‚¨"><span>å†…å­˜å­˜å‚¨</span></a></h5>
<p>Spring Securityæä¾›çš„å¯†ç å­˜å‚¨æ–¹å¼æ˜¯éå¸¸å¤šçš„ï¼Œæœ€ç®€å•çš„ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å­¦ä¹ è¿‡ç¨‹ä¸­ä¾¿äºç”¨æ¥æµ‹è¯•çš„å°±æ˜¯ç›´æ¥æŠŠç”¨æˆ·ä¿¡æ¯å­˜åœ¨å†…å­˜é‡Œäº†,å½“ç„¶æˆ‘ä»¬è¿˜éœ€è¦æŒ‡å®šä½¿ç”¨çš„åŠ å¯†æ–¹å¼</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetailsService</span> <span class="token function">users</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">"$2a$16$lPDF8WO5iqGy9xTGwj3iDeDh8G8u47pdkKcb1OKz0wOcQqgr0EF5i"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryUserDetailsManager</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">BCryptPasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯†ç ç”Ÿæˆæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ä»£ç è®¾ç½®</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create an encoder with strength 16</span>
        <span class="token class-name">BCryptPasswordEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Spring Securityè¿˜ä¸ºæˆ‘ä»¬æä¾›äº†éå¸¸å¤šçš„åŠ å¯†æ–¹å¼çš„ï¼Œä¸è¿‡å…¶é»˜è®¤é‡‡ç”¨çš„æ˜¯DelegatingPasswordEncoderåŠ å¯†æ–¹å¼ï¼Œæ›´å¤šçš„å¯ä»¥æµè§ˆå®˜æ–¹è¯´æ˜</p>
<p><a href="https://springdoc.cn/spring-security/features/authentication/password-storage.html#authentication-password-storage-dpe" title="https://springdoc.cn/spring-security/features/authentication/password-storage.html#authentication-password-storage-dpe" target="_blank" rel="noopener noreferrer">https://springdoc.cn/spring-security/features/authentication/password-storage.html#authentication-password-storage-dpe<ExternalLinkIcon/></a></p>
<p>é‡Œé¢æåˆ°å¾ˆå¤šåŠ å¯†æ–¹å¼éƒ½æ˜¯ç›¸å¯¹å®‰å…¨çš„ï¼Œå½“ç„¶é€‰æ‹©äº†å¯¹åº”çš„åŠ å¯†æ–¹å¼ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠå¯¹åº”çš„<code v-pre>PasswordEncoder</code>æš´éœ²å‡ºæ¥ä¾›Springä½¿ç”¨æ‰è¡Œå–”ï¼Œå°±åƒä¸‹é¢è¿™æ ·</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ•°æ®åº“å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#æ•°æ®åº“å­˜å‚¨"><span>æ•°æ®åº“å­˜å‚¨</span></a></h5>
<p>å½“ç„¶æˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘ä¸­æ˜¯éœ€è¦ä½¿ç”¨åˆ°æ•°æ®åº“çš„ï¼Œè€ŒSpring Securityæ˜¯ç»™æˆ‘ä»¬æä¾›äº†JDBCçš„å­˜å‚¨æ–¹å¼çš„ï¼ŒåŒ…æ‹¬ä¿®æ”¹å¯†ç ï¼Œéƒ½å¯ä»¥é€šè¿‡é…ç½®è¿›è¡Œå¤„ç†</p>
<p>æ¥ä¸‹æ¥å°±ä»¥Spring Security + Mysqlä¸ºä¾‹</p>
<p>é¦–å…ˆæˆ‘ä»¬å½“ç„¶éœ€è¦å…ˆå…·å¤‡ä¸€å¼ User è¡¨</p>
<div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre v-pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>sys_user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç”¨æˆ·ID'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç”¨æˆ·è´¦å·'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>nick_name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç”¨æˆ·æ˜µç§°'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'00'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç”¨æˆ·ç±»å‹ï¼ˆ00ç³»ç»Ÿç”¨æˆ·ï¼‰'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>email<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç”¨æˆ·é‚®ç®±'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>phonenumber<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰‹æœºå·ç '</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>sex<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”· 1å¥³ 2æœªçŸ¥ï¼‰'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>avatar<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'å¤´åƒåœ°å€'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>password<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'å¯†ç '</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å¸å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>login_ip<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€åç™»å½•IP'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>login_date<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€åç™»å½•æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>remark<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å¤‡æ³¨'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_user<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºè€…'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_user<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ›´æ–°è€…'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ›´æ–°æ—¶é—´'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>del_flag<span class="token punctuation">`</span></span> <span class="token keyword">bit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'é€»è¾‘åˆ é™¤(1:å·²åˆ é™¤ï¼Œ0:æœªåˆ é™¤)'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1686027685614125058</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb3 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'ç”¨æˆ·ä¿¡æ¯è¡¨'</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¼å…¥Druid é©±åŠ¨ å’Œ Mybatis plus ç”¨äºæ“ä½œæ•°æ®åº“</p>
<div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre v-pre class="language-xml"><code>       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.5.4.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå®ä½“ç±»ï¼ŒSpring Security ç»™æˆ‘ä»¬æä¾›äº†UseråŸºç¡€å®ä½“ç±»ç»™æˆ‘ä»¬ä½¿ç”¨çš„ï¼Œæˆ‘ä»¬åªéœ€å†™ä¸€äº›é¢å¤–çš„å±æ€§å³å¯</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@Setter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserVo</span> <span class="token keyword">extends</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> phone<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserVo</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸å¦¨æˆ‘ä»¬å¯ä»¥ç‚¹è¿›Userçœ‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªåŸºç¡€å®ä½“ç±»ä¸­å·²ç»å«æœ‰usernameå’Œpasswordï¼Œå¹¶ä¸”å®ç°äº†UserDetailsäº†ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨è¯¥æä¾›çš„Userç±»ï¼Œæˆ‘ä»¬ä¹Ÿè¦æ¨¡æ‹Ÿè¿™ä¸ªåšæ³•ï¼Œå®ç°UserDetailsæ¥å£ï¼Œè¿™æ ·æ‰èƒ½ç»¼åˆUserDetailsServicesæ¥å£è·å–ç”¨æˆ·æŒä¹…åŒ–å‡­è¯ä¿¡æ¯</p>
<p>ä¸è¿‡ä»Userè¿™ä¸ªç±»å¯ä»¥çœ‹å‡ºæ¥ä»–é…ç½®çš„æ˜¯usernameå’Œpasswordï¼Œä¸ä¸€å®šå°±è·Ÿæˆ‘ä»¬çš„æ•°æ®åº“æ˜¯å¯¹åº”ä¸Šçš„</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetails</span><span class="token punctuation">,</span> <span class="token class-name">CredentialsContainer</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">610L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Log</span> logger <span class="token operator">=</span> <span class="token class-name">LogFactory</span><span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> accountNonExpired<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> accountNonLocked<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> credentialsNonExpired<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> enabled<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ˜¯æˆ‘ä»¬è‡ªåˆ›çš„UserVo ä¸æƒ³ä½¿ç”¨Userçš„è¯ï¼Œé‚£å®ç°UserDetailså³å¯ï¼Œè¿™ä¸ªæ˜¯ç”¨äºæ¥å—æˆ‘ä»¬è¾“å…¥çš„æ•°æ®çš„</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token string">"sys_user"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ToString</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUser</span>  <span class="token keyword">implements</span> <span class="token class-name">Serializable</span><span class="token punctuation">,</span> <span class="token class-name">UserDetails</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * ç”¨æˆ·ID
     */</span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç”¨æˆ·è´¦å·
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç”¨æˆ·æ˜µç§°
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> nickName<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç”¨æˆ·ç±»å‹ï¼ˆ00ç³»ç»Ÿç”¨æˆ·ï¼‰
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userType<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç”¨æˆ·é‚®ç®±
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ‰‹æœºå·ç 
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> phonenumber<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ç”¨æˆ·æ€§åˆ«ï¼ˆ0ç”· 1å¥³ 2æœªçŸ¥ï¼‰
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> sex<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å¤´åƒåœ°å€
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> avatar<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å¯†ç 
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å¸å·çŠ¶æ€ï¼ˆ0æ­£å¸¸ 1åœç”¨ï¼‰
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> status<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æœ€åç™»å½•IP
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> loginIp<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æœ€åç™»å½•æ—¶é—´
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> loginDate<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å¤‡æ³¨
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> remark<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * åˆ›å»ºè€…
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> createUser<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * åˆ›å»ºæ—¶é—´
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ›´æ–°è€…
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> updateUser<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ›´æ–°æ—¶é—´
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * é€»è¾‘åˆ é™¤(1:å·²åˆ é™¤ï¼Œ0:æœªåˆ é™¤)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> del_flag<span class="token punctuation">;</span>


    <span class="token keyword">private</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> <span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authorities<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> userName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isAccountNonLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCredentialsNonExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦åˆ›å»ºä¸€ä¸ªUserImplå®ç°SpringSecurityæä¾›çš„UserDetailsServiceæ¥å£ï¼Œå¯ä»¥çœ‹åˆ°ä»–å°±æ˜¯ç”¨UserDetailsè¿›è¡Œæ¥æ”¶æˆ‘ä»¬çš„ç”¨æˆ·ä¿¡æ¯çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¦é€šè¿‡å®ä½“ç±»å®ç°è¿™ä¸ªæ¥å£çš„åŸå› </p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysUserServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUserMapper</span><span class="token punctuation">,</span> <span class="token class-name">SysUser</span><span class="token punctuation">></span></span>
    <span class="token keyword">implements</span> <span class="token class-name">SysUserService</span><span class="token punctuation">,</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬åªéœ€è¦å®ç°loadUserByUsernameæ–¹æ³•ï¼Œè·‘é€šè¯¥æ–¹æ³•ï¼Œç”¨æˆ·å‡­è¯ä¿¡æ¯å°±ä¼šè¢«å­˜äºUserDetails</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysUser</span><span class="token punctuation">></span></span> queryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOne</span><span class="token punctuation">(</span>queryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆç”¨æˆ·ä¿¡æ¯å¦‚ä½•è¿›è¡Œæ ¡éªŒå‘¢ï¼Ÿåªéœ€ä½¿ç”¨AuthenticationManagerå¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ ¡éªŒå³å¯ï¼Œæ–¹æ³•è¿˜æ˜¯éå¸¸ç®€å•çš„</p>
<p>å…ˆå…¨å±€æ³¨å…¥AuthenticationManager Bean </p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AuthenticationManager</span> <span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationConfiguration</span> authenticationConfiguration<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> authenticationConfiguration<span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">Login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SysUser</span> sysUser<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">UsernamePasswordAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sysUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Authentication</span> authenticate <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>authenticate<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">"fail"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åæˆ‘ä»¬éœ€è¦ä¿®æ”¹Spring Security é…ç½®ï¼ŒrequestMatchersè¡¨ç¤ºå¯¹è¯¥è·¯å¾„è¯·æ±‚æ”¾è¡Œï¼Œå¹¶ç¦ç”¨é»˜è®¤å¼€å¯çš„corsï¼Œcsrfï¼ŒformLogin</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http
<span class="token comment">//                .userDetailsService(userService)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                    auth
                            <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/system/auth/login"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span>c <span class="token operator">-></span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span>c <span class="token operator">-></span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span>f <span class="token operator">-></span> <span class="token punctuation">{</span>
                    f<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®Œæˆè‡³è¿™éƒ¨ï¼Œç®€å•çš„ç”¨æˆ·è®¤è¯å°±ç®—å®Œæˆäº†ã€‚</p>
<figure><img src="@source/backend/image/image_6W62PtYUyY.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<h3 id="è®¤è¯æµç¨‹åˆ†æ" tabindex="-1"><a class="header-anchor" href="#è®¤è¯æµç¨‹åˆ†æ"><span>è®¤è¯æµç¨‹åˆ†æ</span></a></h3>
<p>æµ…è¯•äº†Spring Security çš„è®¤è¯ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¸€èµ·æ¥çœ‹çœ‹ä»¥ä¸Šçš„ç”¨æˆ·è®¤è¯æ˜¯æ€ä¹ˆåœ¨Spring Security è·‘é€šçš„å§,é¦–å…ˆå¤§å®¶å¯ä»¥å…ˆå›å¤´å›é¡¾ä¸€ä¸‹æ ¸å¿ƒç»„ä»¶çš„å†…å®¹ï¼Œç„¶åæˆ‘ä»¬å°±ä¸€å—èµ°è¿›Spring Securityå’¯</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å…ˆæ‰¾åˆ°å…¥å£ï¼Œä»ä»¥ä¸‹ä»£ç æ¥çœ‹ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡è¯·æ±‚ä¸­ä¼ è¿‡æ¥çš„ç”¨æˆ·åï¼Œå¯†ç åŒ…è£…æˆUsernamePasswordAuthenticationTokenä¼ ç»™äº†Authenticationï¼Œæ‰€ä»¥å¾ˆæ˜¾ç„¶ï¼ŒAuthenticationå°±æ˜¯æˆ‘ä»¬éœ€è¦æ¢ç´¢çš„å…¥å£</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>  <span class="token class-name">UsernamePasswordAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sysUser<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Authentication</span> authenticate <span class="token operator">=</span> authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AuthenticationManager</span> <span class="token punctuation">{</span>
    <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·‘è¿›å»åï¼Œæˆ‘ä»¬å‘ç°AuthenticationManageræ˜¯ ä¸€ä¸ªæ¥å£ï¼Œä¸è¿‡ProviderManageræ˜¯AuthenticationManageræœ€å¸¸ç”¨çš„å®ç°ç±»äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬æœæ–­å°†æ–­ç‚¹æ‰“åˆ°è¯¥å®ç°ç±»ä¸Šï¼Œä»¥ä¸‹å°±æ˜¯è®¤è¯æ ¸å¿ƒä»£ç </p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Authentication</span><span class="token punctuation">></span></span> toTest <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AuthenticationException</span> lastException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">AuthenticationException</span> parentException <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Authentication</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Authentication</span> parentResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> currentPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>providers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Iterator</span> var9 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getProviders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var9<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AuthenticationProvider</span> provider <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationProvider</span><span class="token punctuation">)</span>var9<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>toTest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Log</span> var10000 <span class="token operator">=</span> logger<span class="token punctuation">;</span>
                    <span class="token class-name">String</span> var10002 <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">++</span>currentPosition<span class="token punctuation">;</span>
                    var10000<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Authenticating request with %s (%d/%d)"</span><span class="token punctuation">,</span> var10002<span class="token punctuation">,</span> currentPosition<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">copyDetails</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> <span class="token operator">|</span> <span class="token class-name">AccountStatusException</span> var14<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareException</span><span class="token punctuation">(</span>var14<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> var14<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> var15<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lastException <span class="token operator">=</span> var15<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                parentResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result <span class="token operator">=</span> parentResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProviderNotFoundException</span> var12<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> var13<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                parentException <span class="token operator">=</span> var13<span class="token punctuation">;</span>
                lastException <span class="token operator">=</span> var13<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eraseCredentialsAfterAuthentication <span class="token operator">&amp;&amp;</span> result <span class="token keyword">instanceof</span> <span class="token class-name">CredentialsContainer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CredentialsContainer</span><span class="token punctuation">)</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentResult <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>eventPublisher<span class="token punctuation">.</span><span class="token function">publishAuthenticationSuccess</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lastException <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProviderNotFoundException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"ProviderManager.providerNotFound"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>toTest<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"No AuthenticationProvider found for {0}"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareException</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span><span class="token punctuation">)</span>lastException<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">throw</span> lastException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬ä¸»è¦å…³æ³¨è¿™éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†å¯ä¸å°±æ˜¯è·Ÿå›¾å¯¹åº”èµ·æ¥äº†å—ï¼Ÿæ²¡é”™ProviderManagerå°±æ˜¯ç®¡ç†æ‰€æœ‰çš„AuthenticationProviderï¼Œè€Œä»£ç ä¸­ä¸å°±æ˜¯éå†æ‰€æœ‰çš„AuthenticationProviderï¼Œå¹¶æŠŠæˆ‘ä»¬ä¼ å…¥çš„å¾…è®¤è¯ä¿¡æ¯ä¼ ç»™æ¯ä¸ªAuthenticationProviderè¿›è¡Œæ ¡éªŒå—ï¼Ÿ</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>  <span class="token keyword">while</span><span class="token punctuation">(</span>var9<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AuthenticationProvider</span> provider <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationProvider</span><span class="token punctuation">)</span>var9<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>toTest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Log</span> var10000 <span class="token operator">=</span> logger<span class="token punctuation">;</span>
                    <span class="token class-name">String</span> var10002 <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">++</span>currentPosition<span class="token punctuation">;</span>
                    var10000<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token class-name">LogMessage</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Authenticating request with %s (%d/%d)"</span><span class="token punctuation">,</span> var10002<span class="token punctuation">,</span> currentPosition<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">copyDetails</span><span class="token punctuation">(</span>authentication<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> <span class="token operator">|</span> <span class="token class-name">AccountStatusException</span> var14<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareException</span><span class="token punctuation">(</span>var14<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> var14<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> var15<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lastException <span class="token operator">=</span> var15<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="@source/backend/image/image_BuD9G2nIWy.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<p>é‚£æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹providersä¸­éƒ½æœ‰ä»€ä¹ˆï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯DaoAuthenticationProviderï¼Œè¿›å…¥è¯¥Providerçœ‹çœ‹ä»–æ˜¯åšä»€ä¹ˆçš„ï¼Œç‚¹è¿›å»æˆ‘ä»¬ä¼šå‘ç°è¯¥Provider æ˜¯ç»§æ‰¿äºAbstractUserDetailsAuthenticationProviderçš„ï¼ŒDaoå¦‚æœæˆ‘ä»¬çŒœçš„è¯ï¼Œåº”è¯¥ä¸éš¾çŒœå‡ºæ¥ä»–åº”è¯¥æ˜¯é€šè¿‡æŸ¥è¯¢æ•°æ®åº“æˆ–è€…è¯´æ˜¯å±äºä¸€ä¸ªæ•°æ®å±‚çš„å®ç°ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯å¾—å…ˆçœ‹çœ‹å…¶çˆ¶ç±»åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿå†é€æ­¥å›åˆ°å­ç±»å¯¹çˆ¶ç±»æ–¹æ³•çš„å®ç°</p>
<figure><img src="@source/backend/image/image_ZFQtLDcSZp.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<p>è·‘åˆ°çˆ¶ç±»AbstractUserDetailsAuthenticationProviderï¼Œæœ€æœ€æ˜¾çœ¼çš„è‡ªç„¶å°±æ˜¯authenticateäº†ï¼Œä»åå­—çœ‹å°±èƒ½çœ‹å‡ºæ¥ä»–åº”è¯¥æ˜¯è®¤è¯çš„æ ¸å¿ƒæ–¹æ³•äº†ï¼Œå…¶å®è¿™æ®µä»£ç å¾ˆæ˜æ˜¾æ˜¯åšäº†ç”¨æˆ·è®¤è¯ä¿¡æ¯çš„æ£€æŸ¥æ ¡éªŒäº†</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isInstanceOf</span><span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> authentication<span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">this</span><span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.onlySupports"</span><span class="token punctuation">,</span>
            <span class="token string">"Only UsernamePasswordAuthenticationToken is supported"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token function">determineUsername</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> cacheWasUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">//ä»ç¼“å­˜ä¸­è·å–ç”¨æˆ·ä¿¡æ¯</span>
    <span class="token class-name">UserDetails</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userCache<span class="token punctuation">.</span><span class="token function">getUserFromCache</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cacheWasUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//ç¼“å­˜æ²¡æœ‰çš„æƒ…å†µ</span>
        user <span class="token operator">=</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Failed to find user '"</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hideUserNotFoundExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
          <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">"retrieveUser returned null - a violation of the interface contract"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">//å‰æ£€æŸ¥ç”±DefaultPreAuthenticationChecksç±»å®ç°ï¼ˆä¸»è¦åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦é”å®šï¼Œè¿‡æœŸï¼Œå†»ç»“Useræ¥å£ï¼‰</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>preAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//æ ¡éªŒä¿¡æ¯ï¼Œç”±å­ç±»å®ç°</span>
      <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AuthenticationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheWasUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// There was a problem, so try again after checking</span>
      <span class="token comment">// we're using latest data (i.e. not from the cache)</span>
      cacheWasUsed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      user <span class="token operator">=</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>preAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>postAuthenticationChecks<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cacheWasUsed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>userCache<span class="token punctuation">.</span><span class="token function">putUserInCache</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Object</span> principalToReturn <span class="token operator">=</span> user<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>forcePrincipalAsString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      principalToReturn <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">createSuccessAuthentication</span><span class="token punctuation">(</span>principalToReturn<span class="token punctuation">,</span> authentication<span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥çœ‹çœ‹å­ç±»æ˜¯æ€ä¹ˆå®ç°è¿™äº›æ–¹æ³•çš„ï¼Œå…¶ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•æ˜¯å­ç±»å®ç°çš„ï¼Œä¸¤ä¸ªæ–¹æ³•çš„é€»è¾‘å¾ˆç®€å•æ˜äº†äº†ï¼Œ1æ˜¯è°ƒç”¨äº†loadUserByUsernameæ–¹æ³•ï¼Œ2æ˜¯å¯†ç æ¯”å¯¹ï¼Œè€ŒloadUserByUsernameå°±æ˜¯æˆ‘ä»¬å®ç°çš„Serviceæ–¹æ³•äº†</p>
<p>æ ¡éªŒä¸»è¦æœ‰ä¸‰æ­¥</p>
<ol>
<li>preAuthenticationChecks å‰æ£€æŸ¥ç”±DefaultPreAuthenticationChecksç±»å®ç°ä¸»è¦åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦é”å®šï¼Œè¿‡æœŸï¼Œå†»ç»“</li>
<li>additionalAuthenticationChecksï¼ˆæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»å®ç°ï¼‰å¯†ç æ¯”å¯¹</li>
<li>postAuthenticationChecks æ£€æµ‹ç”¨æˆ·å¯†ç æ˜¯å¦è¿‡æœŸ</li>
</ol>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
  <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">UserDetails</span> <span class="token function">retrieveUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token function">prepareTimingAttackProtection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">UserDetails</span> loadedUser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getUserDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>loadedUser <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">(</span>
            <span class="token string">"UserDetailsService returned null, which is an interface contract violation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> loadedUser<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UsernameNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">mitigateAgainstTimingAttack</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InternalAuthenticationServiceException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalAuthenticationServiceException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
  <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"deprecation"</span><span class="token punctuation">)</span>
  <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">additionalAuthenticationChecks</span><span class="token punctuation">(</span><span class="token class-name">UserDetails</span> userDetails<span class="token punctuation">,</span>
      <span class="token class-name">UsernamePasswordAuthenticationToken</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Failed to authenticate since no credentials provided"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
        <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> presentedPassword <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>presentedPassword<span class="token punctuation">,</span> userDetails<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Failed to authenticate since password does not match stored value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages
        <span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span><span class="token punctuation">,</span> <span class="token string">"Bad credentials"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬çš„ç”¨æˆ·åï¼Œå¯†ç çš„è®¤è¯æµç¨‹å¯ä»¥å…ˆåˆ°è¿™ä¸ªå‘Šä¸€æ®µè½äº†ï¼Œä¸ºäº†èƒ½è®©æ•´ä¸ªæµç¨‹æ›´åŠ ç›´è§‚ï¼Œå¯ä»¥æ ¹æ®ä¸‹å›¾å†è·‘è·‘debug ï¼Œç›¸ä¿¡ä¼šæ›´åŠ æ¸…æ™°çš„</p>
<figure><img src="@source/backend/image/image_ZuSTsAricF.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<h3 id="è¿‡æ»¤å™¨é“¾" tabindex="-1"><a class="header-anchor" href="#è¿‡æ»¤å™¨é“¾"><span>è¿‡æ»¤å™¨é“¾</span></a></h3>
<p>åŸºæœ¬çš„è®¤è¯æµç¨‹åˆ°è¿™é‡Œç›¸ä¿¡å¤§å®¶æœ‰äº†ä¸å°‘äº†è§£ï¼Œè€Œåˆšåˆšæˆ‘ä»¬ç ”ç©¶çš„éƒ½åªæ˜¯Spring Security ä¸­çš„ä¸€æ¡è¿‡æ»¤é“¾ï¼Œå³UsernamePasswordAuthenticationFilterï¼Œè€Œåœ¨Spring Securityä¸­è¿˜æ˜¯æœ‰å¾ˆå¤šè¿‡æ»¤é“¾çš„ï¼ŒåŒ…æ‹¬æˆ‘ä»¬éœ€è¦æ‹“å±•Spring Securityçš„åŠŸèƒ½ï¼Œæœ€å¥½çš„æ–¹å¼ä¹Ÿæ˜¯æ·»åŠ ä¸€ä¸ªFilteråˆ°å…¶ä¸­</p>
<p>Spring Security æ˜¯ç”±ä¸€ç³»åˆ—çš„è¿‡æ»¤é“¾é…åˆå®Œæˆï¼Œæ›´åŠ ç›´è§‚åœ°è¯´å‘¢ï¼Œå°±æ˜¯ä¸ç®¡ä½ æ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ï¼Œéƒ½å¿…é¡»ç»è¿‡ä»–æ¯ä¸€å±‚è¿‡æ»¤å™¨çš„æ ¡éªŒï¼Œæ ¡éªŒ<strong>éƒ½é€šè¿‡</strong>æ‰èƒ½é¡ºåˆ©è®¿é—®åˆ°åç«¯æœåŠ¡å™¨ï¼Œä»–å°±æ˜¯æˆ‘ä»¬è®¿é—®åç«¯æœåŠ¡å™¨è·¯é€”ä¸­çš„å±‚å±‚å…³å¡</p>
<figure><img src="@source/backend/image/image_gcZer2ZKEp.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<p>å½“ç„¶æ¯ä¸ªè¿‡æ»¤å™¨éƒ½æœ‰å…¶èŒè´£çš„</p>
<ul>
<li>WebAsyncManagerIntegrationFilter æ­¤è¿‡æ»¤å™¨ç”¨äºé›†æˆSecurityContextåˆ°Springå¼‚æ­¥æ‰§è¡Œæœºåˆ¶ä¸­çš„WebAsyncManager</li>
<li>UsernamePasswordAuthenticationFilter è®¤è¯æ“ä½œå…¨é è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œé»˜è®¤åŒ¹é…URLä¸º/loginä¸”å¿…é¡»ä¸ºPOSTè¯·æ±‚ã€‚</li>
<li>BasicAuthenticationFilter æ­¤è¿‡æ»¤å™¨ä¼šè‡ªåŠ¨è§£æHTTPè¯·æ±‚ä¸­å¤´éƒ¨åå­—ä¸ºAuthenticationï¼Œä¸”ä»¥Basicå¼€å¤´çš„å¤´ä¿¡æ¯ã€‚</li>
<li>DefaultLoginPageGeneratingFilter é»˜è®¤çš„ç™»é™†é¡µé¢ç”Ÿæˆè¿‡æ»¤å™¨ï¼Œç”¨äºç”Ÿæˆä¸€ä¸ªç™»å½•é¡µï¼Œå¦‚æœæ²¡æœ‰ç¦ç”¨ï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨ç»™æˆ‘ä»¬ç”Ÿæˆå¯¹åº”çš„ç™»é™†é¡µï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå½“æˆ‘ä»¬å¼•å…¥Spring Securityæ—¶ä¼šè‡ªåŠ¨äº§ç”Ÿä¸€ä¸ªç™»å½•é¡µçš„åŸå› </li>
<li>DefaultLogoutPageGeneratingFilter å¦‚æœæ²¡æœ‰ç¦ç”¨è¯¥åŠŸèƒ½ï¼Œä¼šç”Ÿæˆä¸€ä¸ªæ³¨é”€é¡µ</li>
<li>ExceptionTranslationFilter å¼‚å¸¸è½¬æ¢è¿‡æ»¤å™¨ä½äºæ•´ä¸ªspringSecurityFilterChainçš„åæ–¹ï¼Œç”¨æ¥è½¬æ¢æ•´ä¸ªé“¾è·¯ä¸­å‡ºç°çš„å¼‚å¸¸</li>
<li>FilterSecurityInterceptor  è·å–æ‰€é…ç½®èµ„æºè®¿é—®çš„æˆæƒä¿¡æ¯ï¼Œæ ¹æ®SecurityContextHolderä¸­å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯æ¥å†³å®šå…¶æ˜¯å¦æœ‰æƒé™ã€‚</li>
</ul>
<p>æŠŠæ•´ä¸ªè¿‡æ»¤å™¨é“¾ç†Ÿæ‚‰ä¸‹æ¥ï¼Œå¯¹äºåé¢å¯¹Spring Security æ‹“å±•æ˜¯ååˆ†æœ‰å¸®åŠ©çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å…ˆèŠ±ç‚¹æ—¶é—´è®°ä½è¿™æ¡è¿‡æ»¤å™¨é“¾ã€‚</p>
<p>å½“æˆ‘ä»¬å¼€å¯Spring Security æ—¥å¿—æ—¶ï¼ŒSpring é¡¹ç›®å¼€å¯æ—¶ï¼Œä¼šå‡ºç°ä»¥ä¸‹æ—¥å¿—</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span>SecurityContextPersistenceFilter</span><span class="token annotation punctuation">@8851ce1</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>header<span class="token punctuation">.</span></span>HeaderWriterFilter</span><span class="token annotation punctuation">@6a472566</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>csrf<span class="token punctuation">.</span></span>CsrfFilter</span><span class="token annotation punctuation">@61cd1c71</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>logout<span class="token punctuation">.</span></span>LogoutFilter</span><span class="token annotation punctuation">@5e1d03d7</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span>UsernamePasswordAuthenticationFilter</span><span class="token annotation punctuation">@122d6c22</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>savedrequest<span class="token punctuation">.</span></span>RequestCacheAwareFilter</span><span class="token annotation punctuation">@5ef6fd7f</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servletapi<span class="token punctuation">.</span></span>SecurityContextHolderAwareRequestFilter</span><span class="token annotation punctuation">@4beaf6bd</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span></span>AnonymousAuthenticationFilter</span><span class="token annotation punctuation">@6edcad64</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>session<span class="token punctuation">.</span></span>SessionManagementFilter</span><span class="token annotation punctuation">@5e65afb6</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>access<span class="token punctuation">.</span></span>ExceptionTranslationFilter</span><span class="token annotation punctuation">@5b9396d3</span><span class="token punctuation">,</span>
<span class="token class-name"><span class="token namespace">o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>s<span class="token punctuation">.</span>web<span class="token punctuation">.</span>access<span class="token punctuation">.</span>intercept<span class="token punctuation">.</span></span>FilterSecurityInterceptor</span><span class="token annotation punctuation">@3c5dbdf8</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®¸å¤šè¿‡æ»¤å™¨å…¶å®éƒ½æ˜¯æœ›æ–‡ç”Ÿä¹‰çš„ã€‚</p>
<h3 id="remeber-me" tabindex="-1"><a class="header-anchor" href="#remeber-me"><span>Remeber me </span></a></h3>
<p>ä¸ºè§£å†³session è¿‡æœŸåç”¨æˆ·çš„ç›´æ¥è®¿é—®é—®é¢˜ï¼ŒSpring Security æä¾›å¼€ç®±å³ç”¨çš„é…ç½®remember me</p>
<p>åŸç†ï¼š</p>
<figure><img src="@source/backend/image/image_LLFEoToHsv.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<ul>
<li>å½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶ï¼Œéœ€è¦ç”¨æˆ·åå¯†ç è®¤è¯ï¼Œæ‰€ä»¥ä¼šèµ°UserPasswordAuthenticationFilterï¼Œè®¤è¯æˆåŠŸåä¼šåœ¨RemembermeServiceç”ŸæˆTokenå¹¶é€šè¿‡TokenRepositoryå†™åˆ°æ•°æ®åº“ä¸­ï¼Œå‘é€åˆ°æµè§ˆå™¨çš„Tokenä¼šå­˜å‚¨åˆ°cookieså½“ä¸­ã€‚</li>
<li>ç¬¬äºŒæ¬¡è®¿é—®æˆ–è€…æœåŠ¡é‡å¯åï¼Œæµè§ˆå™¨å†æ¬¡è®¿é—®ä¼šå¸¦ç€Tokenè¿›è¡Œè®¿é—®ï¼Œæ­¤æ—¶ä¼šèµ°RemembermeAuthenticationFilterï¼ŒRemembermeAuthenticationFilterä¸»è¦å°±æ˜¯Cookiesä¸­è·å–Tokené€šè¿‡RemembermeServiceæŸ¥è¯¢æ•°æ®åº“ï¼Œæœ€åè·å–å“åº”ä¿¡æ¯å­˜å‚¨åˆ°UserDetailsä¸­ã€‚</li>
<li>ä½¿ç”¨cookie å­˜å‚¨ç”¨æˆ·åï¼Œè¿‡æœŸæ—¶é—´ï¼Œä»¥åŠä¸€ä¸ªHashHashæ˜¯ç”±md5(ç”¨æˆ·å+è¿‡æœŸæ—¶é—´+å¯†ç +key)</li>
</ul>
<h4 id="å¼€å¯remeber-me" tabindex="-1"><a class="header-anchor" href="#å¼€å¯remeber-me"><span>å¼€å¯Remeber me</span></a></h4>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">,</span><span class="token class-name">RememberMeServices</span> rememberMeServices<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        http
<span class="token comment">//                .userDetailsService(userService)</span>
                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span>
                    auth
                            <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/system/auth/login"</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span>c <span class="token operator">-></span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span>c <span class="token operator">-></span> <span class="token punctuation">{</span>
                    c<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span>f <span class="token operator">-></span> <span class="token punctuation">{</span>
                    f<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span>r <span class="token operator">-></span> <span class="token punctuation">{</span>
                    r<span class="token punctuation">.</span><span class="token function">rememberMeServices</span><span class="token punctuation">(</span>rememberMeServices<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RememberMeServices</span> <span class="token function">rememberMeServices</span><span class="token punctuation">(</span><span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TokenBasedRememberMeServices<span class="token punctuation">.</span>RememberMeTokenAlgorithm</span> encodingAlgorithm <span class="token operator">=</span> <span class="token class-name">TokenBasedRememberMeServices<span class="token punctuation">.</span>RememberMeTokenAlgorithm</span><span class="token punctuation">.</span><span class="token constant">SHA256</span><span class="token punctuation">;</span>
        <span class="token class-name">TokenBasedRememberMeServices</span> rememberMe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenBasedRememberMeServices</span><span class="token punctuation">(</span><span class="token string">"123456"</span><span class="token punctuation">,</span> userDetailsService<span class="token punctuation">,</span> encodingAlgorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rememberMe<span class="token punctuation">.</span><span class="token function">setMatchingAlgorithm</span><span class="token punctuation">(</span><span class="token class-name">TokenBasedRememberMeServices<span class="token punctuation">.</span>RememberMeTokenAlgorithm</span><span class="token punctuation">.</span><span class="token constant">MD5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rememberMe<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ³¨é”€" tabindex="-1"><a class="header-anchor" href="#æ³¨é”€"><span>æ³¨é”€</span></a></h3>
<p>Spring Securityæœ¬èº«å°±å¯¹æ³¨é”€æœ‰æ”¯æŒçš„ï¼Œé»˜è®¤çš„urlæ˜¯/logout,å½“æˆ‘ä»¬æ³¨é”€çš„æ—¶å€™ï¼ŒSpring Securityä¼šæœ‰ä¸€äº›é»˜è®¤è¡Œä¸º</p>
<ul>
<li>ä½¿ HTTP sessionæ— æ•ˆ </li>
<li>æ¸…ç† <a href="https://springdoc.cn/spring-security/servlet/authentication/session-management.html#use-securitycontextholderstrategy" title="SecurityContextHolderStrategy" target="_blank" rel="noopener noreferrer">SecurityContextHolderStrategy<ExternalLinkIcon/></a></li>
<li>æ¸…ç† <a href="https://springdoc.cn/spring-security/servlet/authentication/persistence.html#securitycontextrepository" title="SecurityContextRepository" target="_blank" rel="noopener noreferrer">SecurityContextRepository<ExternalLinkIcon/></a></li>
<li>æ¸…ç†ä»»ä½• <a href="https://springdoc.cn/spring-security/servlet/authentication/rememberme.html" title="RememberMe è®¤è¯" target="_blank" rel="noopener noreferrer">RememberMe è®¤è¯<ExternalLinkIcon/></a> </li>
<li>æ¸…é™¤ä»»ä½•å·²ä¿å­˜çš„ <a href="https://springdoc.cn/spring-security/servlet/exploits/csrf.html" title="CSRF token" target="_blank" rel="noopener noreferrer">CSRF token<ExternalLinkIcon/></a></li>
<li><a href="https://springdoc.cn/spring-security/servlet/authentication/events.html" title="è§¦å‘" target="_blank" rel="noopener noreferrer">è§¦å‘<ExternalLinkIcon/></a> <code v-pre>LogoutSuccessEvent</code></li>
</ul>
<p>å½“ç„¶æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰urlï¼Œåœ¨é…ç½®ä¸­è¿›è¡Œé…ç½®å³å¯ï¼Œè¿˜å¯ä»¥é…ç½®æ³¨é”€æˆåŠŸåæŒ‡å‘çš„è¯·æ±‚</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>http
    <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">(</span>authorize<span class="token punctuation">)</span> <span class="token operator">-></span> authorize
        <span class="token punctuation">.</span><span class="token function">requestMatchers</span><span class="token punctuation">(</span><span class="token string">"/my/success/endpoint"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">(</span>logout<span class="token punctuation">)</span> <span class="token operator">-></span> logout<span class="token punctuation">.</span><span class="token function">logoutSuccessUrl</span><span class="token punctuation">(</span><span class="token string">"/my/success/endpoint"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨é”€å…¶å®ä¹Ÿæ˜¯ä¸ºäº†åšä¸€ä¸ªç”¨æˆ·ä¿¡æ¯æ¸…ç†çš„å·¥ä½œæˆ–è€…å…¶ä»–æ¸…ç†çš„å·¥ä½œï¼ŒSpring Securityä¹Ÿæ˜¯æä¾›äº†éƒ¨åˆ†æ¸…ç†çš„æ–¹æ³•æˆ‘ä»¬ä½¿ç”¨çš„</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token class-name">CookieClearingLogoutHandler</span> cookies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CookieClearingLogoutHandler</span><span class="token punctuation">(</span><span class="token string">"our-custom-cookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http
    <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">(</span>logout<span class="token punctuation">)</span> <span class="token operator">-></span> logout<span class="token punctuation">.</span><span class="token function">addLogoutHandler</span><span class="token punctuation">(</span>cookies<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿˜æœ‰æ›´ä¸ºå®‰å…¨çš„æ¸…ç†æ–¹å¼ï¼Œä½¿ç”¨Clear-Site-Dataæ¥æ¸…ç†ï¼Œè¿™æ˜¯ä¼šç›´æ¥æ¸…ç†æ‰€æœ‰è·Ÿè‡ªå·±ç½‘ç«™ç›¸å…³çš„ç¼“å­˜ï¼Œcookieï¼Œstorageçš„ï¼Œå…¶å®å°±æ˜¯ç»™è¯·æ±‚å¤´æ·»åŠ ä¸€ä¸ªClear-Site-Dataï¼Œè®©æµè§ˆå™¨æ‰§è¡Œè¯¥æŒ‡ä»¤çš„</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token class-name">HeaderWriterLogoutHandler</span> clearSiteData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeaderWriterLogoutHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClearSiteDataHeaderWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http
    <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">(</span>logout<span class="token punctuation">)</span> <span class="token operator">-></span> logout<span class="token punctuation">.</span><span class="token function">addLogoutHandler</span><span class="token punctuation">(</span>clearSiteData<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰ä¸€äº›æ³¨é”€æˆåŠŸçš„äº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼ŒHttpStatusReturningLogoutSuccessHandler å¯ä»¥æ›¿æ¢æˆæˆ‘ä»¬è‡ªå®šä¹‰çš„</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>http
    <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">(</span>logout<span class="token punctuation">)</span> <span class="token operator">-></span> logout<span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpStatusReturningLogoutSuccessHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è®¤è¯äº‹ä»¶" tabindex="-1"><a class="header-anchor" href="#è®¤è¯äº‹ä»¶"><span>è®¤è¯äº‹ä»¶</span></a></h3>
<p>Spring Security å¯¹æ¯ä¸€ä¸ªè®¤è¯æˆåŠŸæˆ–è€…å¤±è´¥éƒ½ä¼šè§¦å‘ç›¸åº”çš„äº‹ä»¶ï¼Œä¸ºäº†ç›‘å¬è¿™äº›äº‹ä»¶ï¼Œä½ å¿…é¡»å…ˆå‘å¸ƒä¸€ä¸ª AuthenticationEventPublisherã€‚Spring Securityçš„ DefaultAuthenticationEventPublisher å¯ä»¥å¾ˆå¥½åœ°å®ç°è¿™ä¸€ç›®çš„ï¼Œç„¶åä½ å¯ä»¥ä½¿ç”¨Springçš„ @EventListener æ”¯æŒ</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">AuthenticationEventPublisher</span> authenticationEventPublisher
        <span class="token punctuation">(</span><span class="token class-name">ApplicationEventPublisher</span> applicationEventPublisher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAuthenticationEventPublisher</span><span class="token punctuation">(</span>applicationEventPublisher<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthenticationEvents</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@EventListener</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationSuccessEvent</span> success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@EventListener</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onFailure</span><span class="token punctuation">(</span><span class="token class-name">AbstractAuthenticationFailureEvent</span> failures<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ‹“å±•å·©å›º" tabindex="-1"><a class="header-anchor" href="#æ‹“å±•å·©å›º"><span>æ‹“å±•å·©å›º</span></a></h3>
<h4 id="æ•´åˆjwt" tabindex="-1"><a class="header-anchor" href="#æ•´åˆjwt"><span>æ•´åˆJWT</span></a></h4>
<p>JWTï¼ˆJSON Web Tokenï¼‰æ˜¯ä¸€ç§åŸºäºJSONçš„å¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œç”¨äºåœ¨ç½‘ç»œåº”ç”¨ç¨‹åºä¹‹é—´å®‰å…¨åœ°ä¼ é€’ä¿¡æ¯ã€‚å®ƒè¢«ç”¨ä½œèº«ä»½éªŒè¯å’Œæˆæƒæœºåˆ¶ï¼Œç”¨äºéªŒè¯ç”¨æˆ·èº«ä»½å’Œè®¿é—®æƒé™ã€‚</p>
<p>æƒ³è¦è¿›ä¸€æ­¥äº†è§£çš„å¯ä»¥çœ‹ï¼š<a href="https://jwt.io/" title="https://jwt.io/" target="_blank" rel="noopener noreferrer">https://jwt.io/<ExternalLinkIcon/></a></p>
<p>ä¼˜åŠ¿ï¼š</p>
<ol>
<li>ç®€å•ï¼šJWT éå¸¸ç®€å•ï¼Œæ˜“äºå®ç°å’Œç†è§£ã€‚</li>
<li>å®‰å…¨ï¼šJWT ä½¿ç”¨å¯†ç å­¦ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œæœºå¯†æ€§ã€‚</li>
<li>è·¨åŸŸï¼šJWT å¯ä»¥åœ¨ä¸åŒçš„åŸŸä¹‹é—´ä¼ é€’ï¼Œä½¿å¾—è·¨åŸŸé€šä¿¡å˜å¾—æ›´åŠ å®¹æ˜“ã€‚</li>
<li>çµæ´»ï¼šJWT å¯ä»¥å­˜å‚¨å¤šç§ç±»å‹çš„æ•°æ®ï¼Œä¾‹å¦‚ç”¨æˆ·IDã€è§’è‰²ã€æƒé™ç­‰ã€‚</li>
<li>æ ‡å‡†åŒ–ï¼šJWT æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼Œå¯ä»¥åœ¨å„ç§ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ä¸­ä½¿ç”¨ã€‚</li>
</ol>
<p>åŠ£åŠ¿ï¼š</p>
<ol>
<li>æœ‰é™çš„ç”¨é€”ï¼šJWT é€šå¸¸ç”¨äºèº«ä»½éªŒè¯å’Œæˆæƒï¼Œä½†åœ¨å…¶ä»–åœºæ™¯ä¸­å¯èƒ½ä¸é€‚ç”¨ã€‚</li>
<li>å®¹æ˜“å—åˆ°ä¸­é—´äººæ”»å‡»ï¼šå¦‚æœ JWT æ²¡æœ‰æ­£ç¡®è®¾ç½®ï¼Œå®¹æ˜“å—åˆ°ä¸­é—´äººæ”»å‡»ï¼Œå¯¼è‡´æ•°æ®æ³„éœ²æˆ–ä¼ªé€ ã€‚</li>
<li>å¯†é’¥ç®¡ç†ï¼šJWT ä½¿ç”¨å¯†ç å­¦ä¿è¯æ•°æ®çš„å®Œæ•´æ€§å’Œæœºå¯†æ€§ï¼Œä½†æ˜¯å¯†é’¥ç®¡ç†éœ€è¦è°¨æ…ï¼Œå¦åˆ™å®¹æ˜“å—åˆ°æ”»å‡»ã€‚</li>
<li>æœ‰é™çš„ä¿¡æ¯ï¼šJWT åªèƒ½å­˜å‚¨æœ‰é™çš„æ•°æ®ï¼Œè¿‡å¤šçš„è£…è½½ä¼šä½¿å¾—è¯·æ±‚å¤´è¿‡é‡</li>
<li>æœ‰é™çš„ç­¾åç®—æ³•ï¼šJWT ä½¿ç”¨å“ˆå¸Œå‡½æ•°è¿›è¡Œç­¾åï¼Œä½†æ˜¯ç›®å‰åªæ”¯æŒ SHA-1 å’Œ SHA-256 ç®—æ³•ï¼Œè¿™å¯èƒ½ä¼šå—åˆ°å®‰å…¨é—®é¢˜çš„å½±å“ã€‚</li>
</ol>
<p>JWTå·¥ä½œæµç¨‹</p>
<figure><img src="@source/backend/image/image_S_i3hAv6Fp.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<p>ä»£ç å®è·µ</p>
<p>é¦–å…ˆéœ€è¦å¼•å…¥ä¾èµ–</p>
<div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre v-pre class="language-xml"><code><span class="token comment">&lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt-api --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jjwt-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.11.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt-impl --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jjwt-impl<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.11.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

        <span class="token comment">&lt;!-- https://mvnrepository.com/artifact/io.jsonwebtoken/jjwt-jackson --></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>io.jsonwebtoken<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jjwt-jackson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.11.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åå°±æ˜¯åˆ›å»ºä¸€ä¸ªJWTå·¥å…·ç±»å¸®åŠ©æˆ‘ä»¬åˆ›å»ºjwt</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtUtils</span> <span class="token punctuation">{</span>

    <span class="token comment">//åˆ›å»ºå¯†é’¥</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Key</span> <span class="token constant">JWT_KEY</span> <span class="token operator">=</span> <span class="token class-name">Keys</span><span class="token punctuation">.</span><span class="token function">secretKeyFor</span><span class="token punctuation">(</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//ä¼ å…¥SysUser æ˜¯ä¸ºäº†æµ‹è¯•ï¼Œæ­£å¸¸æƒ…å†µä¸‹åº”æ˜¯ä¼ å…¥UserDetails</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createJwt</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"userId"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span>user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setIssuedAt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//ç­¾åæ—¶é—´</span>
                <span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>now <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//è¿‡æœŸæ—¶é—´</span>
                <span class="token punctuation">.</span><span class="token function">signWith</span><span class="token punctuation">(</span><span class="token constant">JWT_KEY</span><span class="token punctuation">,</span><span class="token class-name">SignatureAlgorithm</span><span class="token punctuation">.</span><span class="token constant">HS256</span><span class="token punctuation">)</span> <span class="token comment">//ç­¾åå¯†é’¥</span>
                <span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span> <span class="token punctuation">{</span>
        <span class="token class-name">JwtUtils</span> jwtUtils <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SysUser</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jwtUtils<span class="token punctuation">.</span><span class="token function">createJwt</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æµ‹è¯•å¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†å¯¹åº”çš„token äº†</p>
<figure><img src="@source/backend/image/image_HUyL-m0yyc.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<p>é€šè¿‡createJwtå·¥å…·æ–¹æ³•åˆ›å»ºäº†tokenåï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªæ–¹æ³•æ¥å¯¹tokenè¿›è¡Œæ ¡éªŒï¼Œä¸‹é¢ä»£ç å¯¹ä¸¤ä¸ªåœ°æ–¹è¿›è¡Œæ ¡éªŒï¼Œ1æ˜¯è¿‡æœŸæ—¶é—´ï¼Œ2æ˜¯æ˜¯å¦èƒ½å¤Ÿå–åˆ°æ•°æ®</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>   <span class="token doc-comment comment">/**
     * @Description é€šè¿‡tokenè·å–Claims
     * @Author T
     * @Date 2024/4/28 18:51
     **/</span>
    <span class="token keyword">private</span> <span class="token class-name">Claims</span> <span class="token function">getClaimsByJwt</span><span class="token punctuation">(</span><span class="token class-name">String</span> jwt<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span>  <span class="token class-name">Jwts</span><span class="token punctuation">.</span><span class="token function">parser</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setSigningKey</span><span class="token punctuation">(</span><span class="token constant">JWT_KEY</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">parseClaimsJws</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
   <span class="token doc-comment comment">/**
     * @Description æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
     * @Author T
     * @Date 2024/4/28 18:55     
     **/</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validateJwt</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            claims <span class="token operator">=</span> <span class="token function">getClaimsByJwt</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> claims<span class="token punctuation">.</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¥½äº†æœ‰äº†è¿™ä¹ˆä¸ªJWTå·¥å…·ç±»åï¼Œå°±å¯ä»¥å°è¯•æ¥å®Œæˆè¿‡æ»¤å™¨éƒ¨åˆ†äº†ï¼Œå³æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªJWTFilteræ”¾åˆ°Spring Securityçš„è¿‡æ»¤é“¾ä¸Š</p>
<p>JWTFilterå·¥ä½œæœ‰ä¸¤ä¸ª</p>
<ol>
<li>æ ¡éªŒtoken</li>
<li>æ ¡éªŒé€šè¿‡ï¼Œåˆ·æ–°token</li>
<li>æ ¡éªŒä¸é€šè¿‡ï¼Œæ¸…é™¤SecurityContext</li>
</ol>
<p>è€Œtokençš„æ ¼å¼æˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸ºåœ¨è¯·æ±‚å¤´Authorizationä¸Š ï¼Œä»¥Tå¼€å¤´åè·Ÿtokenï¼Œå½“ç„¶è¿™ä¸ªå¯ä»¥è‡ªå·±æ¥è®¾å®šï¼Œä½†æ˜¯åœ¨æ ¡éªŒçš„æ—¶å€™è¦è®°å¾—å¤„ç†</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">checkJwtToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> authorization <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authorization <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authorization<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"T "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> token <span class="token operator">=</span> authorization<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jwtUtils<span class="token punctuation">.</span><span class="token function">validateJwt</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> token<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæˆ‘ä»¬åˆ›å»ºçš„JWTFilterè¦ç»§æ‰¿OncePerRequestFilterç±»ï¼Œè¯¥Filterçš„åŠŸèƒ½è¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒç®€å•çš„ï¼Œå°±æ˜¯æ ¡éªŒtokenï¼Œæœ‰æ•ˆå°±æ„å»ºUsernamePasswordAuthenticationTokenæ”¾åœ¨Contextä¸­è¡¨ç¤ºå·²ç™»é™†ï¼Œæ— æ•ˆåˆ™æ¸…é™¤äº†Context</p>
<p>æ„å»ºUsernamePasswordAuthenticationTokençš„æ—¶å€™è¦æ³¨æ„ï¼Œæˆ‘ä»¬çš„ç›®çš„å…¶å®æ˜¯è®© authenticatedä¸ºtrue è®©åé¢çš„UsernamePasswordAuthenticationFilterè¿‡æ»¤å™¨èƒ½å¤Ÿæ”¾è¡Œï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦æŠŠJWTFilteræ”¾åœ¨UsernamePasswordAuthenticationFilterçš„åŸå› </p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JWTFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtUtils</span> jwtUtils<span class="token punctuation">;</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
         <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">checkJwtToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> username <span class="token operator">=</span> jwtUtils<span class="token punctuation">.</span><span class="token function">getClaimsByJwt</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UsernamePasswordAuthenticationToken</span> authenticationToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            authenticationToken<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">checkJwtToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> authorization <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>authorization <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> authorization<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"T "</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> token <span class="token operator">=</span> authorization<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jwtUtils<span class="token punctuation">.</span><span class="token function">validateJwt</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> token<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¥½äº†ï¼Œè‡³æ­¤ä¸€ä¸ªç®€å•çš„JWTFilter ä¹Ÿå·®ä¸å¤šå®Œæˆäº†ã€‚</p>
<h4 id="æ•´åˆsmsçŸ­ä¿¡ç™»é™†è®¤è¯" tabindex="-1"><a class="header-anchor" href="#æ•´åˆsmsçŸ­ä¿¡ç™»é™†è®¤è¯"><span>æ•´åˆSMSçŸ­ä¿¡ç™»é™†è®¤è¯</span></a></h4>
<p>æˆ‘ä»¬éƒ½çŸ¥é“å…¶å®Spring Securityå…¶å®å°±æ˜¯ä¸€æ¡çš„è¿‡æ»¤é“¾ï¼Œæ‰€ä»¥å¦‚æœè¯´æˆ‘ä»¬æƒ³è¦å¯¹å…¶è¿›è¡Œæ‹“å±•ï¼Œæ˜¯ä¸æ˜¯å¤šåŠ ä¸€æ¡è¿‡æ»¤é“¾å°±è¡Œäº†å‘¢ï¼Ÿç»“æœæ­£æ˜¯å¦‚æ­¤ï¼è·ŸJWT Filterä¸€æ ·çš„ï¼Œåªè¦æ ¡éªŒé€šè¿‡äº†å°±ç›´æ¥SecurityContextHolder.getContext().setAuthentication(authenticationToken)å°±å¯ä»¥äº†ï¼Œé‚£ä¹ˆåé¢çš„ç”¨æˆ·åï¼Œå¯†ç æ ¡éªŒå°±èƒ½é€šè¿‡äº†ã€‚</p>
<p>æ—¢ç„¶Spring Securityæ˜¯ä¸€æ¡è¿‡æ»¤é“¾ï¼Œé‚£ä¹ˆç°åœ¨å°±éœ€è¦ç»™è¿™æ¡é“¾åŠ ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ŒSmsAuthenticationFilterï¼Œ</p>
<p>æ—¢ç„¶éƒ½æ˜¯ç”¨äºç™»å½•çš„è¿‡æ»¤å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å‚è€ƒUsernamePasswordAuthenticationFilteræ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Œçœ‹æºç å¯å¾—çŸ¥UsernamePasswordAuthenticationFilterç»§æ‰¿äºAbstractAuthenticationProcessingFilter</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é‚£ä¹ˆæˆ‘ä»¬å°±æ¥æ¨¡ä»¿ä¸€ä¸‹</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsAuthenticationFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationProcessingFilter</span> <span class="token punctuation">{</span>


    <span class="token keyword">protected</span> <span class="token class-name">SmsAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">String</span> defaultFilterProcessesUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>defaultFilterProcessesUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token class-name">SmsAuthenticationFilter</span><span class="token punctuation">(</span><span class="token class-name">RequestMatcher</span> requiresAuthenticationRequestMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>requiresAuthenticationRequestMatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å†æ¥çœ‹çœ‹UsernamePasswordAuthenticationFilteræºç ï¼ŒUsernamePasswordAuthenticationFilterä¼šä»requestä¸­è·å–usernameï¼Œpasswordï¼ŒåŒæ ·å…¶å®æˆ‘ä»¬æ˜¯éœ€è¦ä»request ä¸­è·å–æ‰‹æœºå·</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_SECURITY_FORM_USERNAME_KEY</span> <span class="token operator">=</span> <span class="token string">"username"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SPRING_SECURITY_FORM_PASSWORD_KEY</span> <span class="token operator">=</span> <span class="token string">"password"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> usernameParameter <span class="token operator">=</span> <span class="token string">"username"</span><span class="token punctuation">;</span> 
    <span class="token keyword">private</span> <span class="token class-name">String</span> passwordParameter <span class="token operator">=</span> <span class="token string">"password"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> postOnly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//åˆ¤æ–­è¯·æ±‚å¿…é¡»æ˜¯postè¯·æ±‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¥½ï¼Œå†å›åˆ°æºç å½“ä¸­</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
        <span class="token comment">//åˆ¤æ–­å¿…é¡»æ˜¯postè¯·æ±‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>postOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">"Authentication method not supported: "</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//ä»requestä¸­è·å–ç”¨æˆ·åå’Œå¯†ç </span>
            <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainUsername</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">obtainPassword</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                username <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>password <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                password <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//ç”Ÿæˆæœªç»è®¤è¯çš„Token</span>
            username <span class="token operator">=</span> username<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getAuthenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>authRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ°è¿™é‡Œéƒ½éå¸¸å¥½æ¨¡ä»¿ï¼Œä»è¿™é‡Œä¾¿èƒ½å¾—çŸ¥äº†è§£æºç çš„é‡è¦æ€§äº†ï¼</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> httpServletResponse<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token comment">//åˆ¤æ–­å¿…é¡»æ˜¯postè¯·æ±‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>postOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationServiceException</span><span class="token punctuation">(</span><span class="token string">"Authentication method not supported: "</span> <span class="token operator">+</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//ä»requestä¸­è·å–æ‰‹æœºå·</span>
            <span class="token class-name">String</span> mobile <span class="token operator">=</span> <span class="token function">obtainMobile</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mobile <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mobile <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mobile <span class="token operator">=</span> mobile<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     *
     * ä»request ä¸­è·å– æ‰‹æœºå·ç 
     *
     * */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">obtainMobile</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"mobile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ä¸‹æ¥å†æ¥çœ‹çœ‹UsernamePasswordAuthenticationTokenæ˜¯æ€ä¹ˆæ„å»ºçš„ï¼Ÿ</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">530L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">;</span>
    
    <span class="token comment">//æ„å»ºæœªè®¤è¯çš„Token</span>
    <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//æ„å»ºå·²è®¤è¯çš„Token</span>
    <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>credentials<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAuthenticated<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAuthenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‹¿åˆ°äº†mobileä»¥åï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åˆ›å»ºä¸€ä¸ªæœªç»è®¤è¯çš„Token</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>

    <span class="token comment">//æ„å»ºæœªè®¤è¯çš„Token</span>
    <span class="token keyword">public</span> <span class="token class-name">SmsAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//æ„å»ºå·²è®¤è¯çš„token</span>
    <span class="token keyword">public</span> <span class="token class-name">SmsAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span>
                                      <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">></span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> principal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> authenticated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>authenticated<span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                   <span class="token string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
           <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è§£ä¸‹æ¥å°±å¯ä»¥å›åˆ°åˆ›å»ºæœªç»è®¤è¯çš„tokenå¤„äº†ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦é€šè¿‡mobileæ¥åˆ›å»ºtoken</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>  <span class="token comment">//æ„å»ºæœªç»è®¤è¯çš„token</span>
  <span class="token class-name">SmsAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsAuthenticationToken</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å†å›åˆ°UsernamePasswordAuthenticationToken ï¼Œçœ‹çœ‹tokenæ˜¯å¦‚ä½•setDetails()çš„</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        authRequest<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾ˆæ˜æ˜¾ï¼Œåªéœ€è¦æŠŠtoken å’Œrequest äº¤ç»™AuthenticationDetails å­˜å‚¨å°±è¡Œäº†</p>
<div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre v-pre class="language-java"><code>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">SmsAuthenticationToken</span> authRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        authRequest<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>authenticationDetailsSource<span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å†çœ‹çœ‹è¿™å¼ å›¾ï¼Œå°±å¾ˆæ¸…æ™°äº†ï¼Œè¿‡ç¨‹å…¶å®æ˜¯éå¸¸ç›¸ä¼¼çš„</p>
<figure><img src="@source/backend/image/image_EvEbIMofpe.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>
<p>å¥½äº†ï¼Œè‡³æ­¤ï¼Œè¿™ä¸ªFilterå…¶å®å°±å·®ä¸å¤šè¯¥å®Œæˆäº†</p>
</div></template>


